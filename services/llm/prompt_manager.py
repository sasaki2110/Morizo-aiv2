#!/usr/bin/env python3
"""
PromptManager - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†

LLMServiceã‹ã‚‰åˆ†é›¢ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†å°‚ç”¨ã‚¯ãƒ©ã‚¹
ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ã¨å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆã‚’æ‹…å½“
"""

from typing import Dict, Any
from config.loggers import GenericLogger


class PromptManager:
    """ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹"""
    
    def __init__(self):
        """åˆæœŸåŒ–"""
        self.logger = GenericLogger("service", "llm.prompt")
    
    def build_planning_prompt(self, user_request: str, sse_session_id: str = None) -> str:
        """
        ã‚¿ã‚¹ã‚¯åˆ†è§£ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æ§‹ç¯‰ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰åå¯¾å¿œç‰ˆï¼‰
        
        Args:
            user_request: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            sse_session_id: SSE session ID (for additional proposal context)
        
        Returns:
            æ§‹ç¯‰ã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        # Phase 1F: è¿½åŠ ææ¡ˆã®å ´åˆã€sse_session_idã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹
        sse_info = ""
        if sse_session_id:
            sse_info = f"\n**ç¾åœ¨ã®SSEã‚»ãƒƒã‚·ãƒ§ãƒ³ID**: {sse_session_id}"
        
        planning_prompt = f"""
ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã‚’åˆ†æã—ã€é©åˆ‡ãªã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã«åˆ†è§£ã—ã¦ãã ã•ã„ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚: "{user_request}"
{sse_info}

åˆ©ç”¨å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ã¨æ©Ÿèƒ½:

- **inventory_service**: åœ¨åº«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
  - `get_inventory()`: ç¾åœ¨ã®å…¨åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã—ã¾ã™ã€‚
  - `add_inventory(item_name: str, quantity: float, ...)`: åœ¨åº«ã«æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ ã—ã¾ã™ã€‚
  - `update_inventory(item_identifier: str, updates: dict, strategy: str)`: åœ¨åº«æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã™ã€‚strategyã«ã¯ 'by_id', 'by_name', 'by_name_all', 'by_name_oldest', 'by_name_latest' ãŒæŒ‡å®šå¯èƒ½ã§ã™ã€‚
  - `delete_inventory(item_identifier: str, strategy: str)`: åœ¨åº«ã‚’å‰Šé™¤ã—ã¾ã™ã€‚strategyã«ã¯ 'by_id', 'by_name', 'by_name_all', 'by_name_oldest', 'by_name_latest' ãŒæŒ‡å®šå¯èƒ½ã§ã™ã€‚

- **recipe_service**: ãƒ¬ã‚·ãƒ”ãƒ»çŒ®ç«‹ã‚µãƒ¼ãƒ“ã‚¹
  - `generate_main_dish_proposals(inventory_items: list, user_id: str, main_ingredient: str, excluded_recipes: list, ...)`: ä¸»èœ5ä»¶ã‚’ææ¡ˆã—ã¾ã™ï¼ˆLLM 2ä»¶ + RAG 3ä»¶ï¼‰ã€‚main_ingredientã§ä¸»è¦é£Ÿæã‚’æŒ‡å®šå¯èƒ½ã€‚excluded_recipesã§é‡è¤‡å›é¿å¯¾è±¡ã®ãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®šã€‚
  - `generate_menu_plan(inventory_items: list, user_id: str, ...)`: åœ¨åº«ãƒªã‚¹ãƒˆã«åŸºã¥ãã€LLMã«ã‚ˆã‚‹ç‹¬å‰µçš„ãªçŒ®ç«‹ææ¡ˆã‚’è¡Œã„ã¾ã™ã€‚éå»ã®å±¥æ­´ã‚‚è€ƒæ…®ã—ã¾ã™ã€‚
  - `search_menu_from_rag(query: str, user_id: str, ...)`: RAGã‚’ä½¿ç”¨ã—ã¦éå»ã®çŒ®ç«‹å±¥æ­´ã‹ã‚‰é¡ä¼¼ã®çŒ®ç«‹ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
  - `search_recipes_from_web(recipe_name: str, ...)`: æŒ‡å®šã•ã‚ŒãŸæ–™ç†åã®ãƒ¬ã‚·ãƒ”ã‚’Webæ¤œç´¢ã—ã€URLã‚’å«ã‚€è©³ç´°æƒ…å ±ã‚’è¿”ã—ã¾ã™ã€‚
  - `get_recipe_history(user_id: str, ...)`: éå»ã®æ–™ç†å±¥æ­´ã‚’å–å¾—ã—ã¾ã™ã€‚

- **history_service**: ãƒ¬ã‚·ãƒ”å±¥æ­´ã‚µãƒ¼ãƒ“ã‚¹
  - `history_get_recent_titles(user_id: str, category: str, days: int, ...)`: æŒ‡å®šæœŸé–“å†…ã®ãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆé‡è¤‡å›é¿ç”¨ï¼‰ã€‚categoryã¯"main"/"sub"/"soup"ã€daysã¯æ—¥æ•°ã€‚

- **session_service**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹
  - `session_get_proposed_titles(sse_session_id: str, category: str, ...)`: ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ææ¡ˆæ¸ˆã¿ã®ãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆè¿½åŠ ææ¡ˆã®é‡è¤‡å›é¿ç”¨ï¼‰ã€‚categoryã¯"main"/"sub"/"soup"ã€‚

**æœ€é‡è¦ãƒ«ãƒ¼ãƒ«: ã‚¿ã‚¹ã‚¯ç”Ÿæˆã®æ¡ä»¶åˆ†å²**

1. **åœ¨åº«æ“ä½œã®ã¿ã®å ´åˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ãŒã€Œè¿½åŠ ã€ã€Œå‰Šé™¤ã€ã€Œæ›´æ–°ã€ã€Œç¢ºèªã€ç­‰ã®åœ¨åº«æ“ä½œã®ã¿ã®å ´åˆã€è©²å½“ã™ã‚‹åœ¨åº«æ“ä½œã‚¿ã‚¹ã‚¯ã®ã¿ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
   
   **ä¾‹**:
   - ã€Œãƒ”ãƒ¼ãƒãƒ³ã‚’ï¼”å€‹è¿½åŠ ã—ã¦ã€â†’ `inventory_service.add_inventory()` ã®ã¿
   - ã€Œç‰›ä¹³ã‚’å‰Šé™¤ã—ã¦ã€â†’ `inventory_service.delete_inventory()` ã®ã¿  
   - ã€Œåœ¨åº«ã‚’ç¢ºèªã—ã¦ã€â†’ `inventory_service.get_inventory()` ã®ã¿

2. **çŒ®ç«‹ç”Ÿæˆã®å ´åˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ãŒã€ŒçŒ®ç«‹ã€ã€Œãƒ¬ã‚·ãƒ”ã€ã€Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ç­‰ã®çŒ®ç«‹ææ¡ˆã«é–¢ã™ã‚‹å ´åˆã®ã¿ã€ä»¥ä¸‹ã®4æ®µéšã®ã‚¿ã‚¹ã‚¯æ§‹æˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
   
   **ä¾‹**:
   - ã€ŒçŒ®ç«‹ã‚’æ•™ãˆã¦ã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ
   - ã€Œãƒ¬ã‚·ãƒ”ã‚’ææ¡ˆã—ã¦ã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ
   - ã€Œåœ¨åº«ã‹ã‚‰ä½œã‚Œã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ï¼Ÿã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ

   a. **task1**: `inventory_service.get_inventory()` ã‚’å‘¼ã³å‡ºã—ã€ç¾åœ¨ã®åœ¨åº«ã‚’ã™ã¹ã¦å–å¾—ã™ã‚‹ã€‚
   b. **task2**: `recipe_service.generate_menu_plan()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸåœ¨åº«æƒ…å ±ã‚’ `inventory_items` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹ã€‚
   c. **task3**: `recipe_service.search_menu_from_rag()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸåœ¨åº«æƒ…å ±ã‚’ `inventory_items` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹ã€‚
   d. **task4**: `recipe_service.search_recipes_from_web()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€ã‚¹ãƒ†ãƒƒãƒ—2ã¨ã‚¹ãƒ†ãƒƒãƒ—3ã®çµæœã‚’é©åˆ‡ã«å‡¦ç†ã™ã‚‹ã€‚

3. **ä¸»èœææ¡ˆã®å ´åˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ãŒã€Œä¸»èœã€ã€Œãƒ¡ã‚¤ãƒ³ã€ã€Œä¸»èœã‚’ææ¡ˆã—ã¦ã€ç­‰ã®ä¸»èœææ¡ˆã«é–¢ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã®4æ®µéšã®ã‚¿ã‚¹ã‚¯æ§‹æˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
   
   **ä¾‹**:
   - ã€Œä¸»èœã‚’5ä»¶ææ¡ˆã—ã¦ã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ
   - ã€Œãƒ¬ãƒ³ã‚³ãƒ³ã‚’ä½¿ã£ãŸä¸»èœã‚’æ•™ãˆã¦ã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ
   - ã€Œãƒ¡ã‚¤ãƒ³ã‚’ææ¡ˆã—ã¦ã€â†’ 4æ®µéšã‚¿ã‚¹ã‚¯æ§‹æˆ

   a. **task1**: `inventory_service.get_inventory()` ã‚’å‘¼ã³å‡ºã—ã€ç¾åœ¨ã®åœ¨åº«ã‚’ã™ã¹ã¦å–å¾—ã™ã‚‹ã€‚
   b. **task2**: `history_service.history_get_recent_titles(user_id, "main", 14)` ã‚’å‘¼ã³å‡ºã—ã€14æ—¥é–“ã®ä¸»èœå±¥æ­´ã‚’å–å¾—ã™ã‚‹ã€‚**é‡è¦**: user_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚ä¾‹: "d0e0d523-1831-4541-bd67-f312386db951"
   c. **task3**: `recipe_service.generate_main_dish_proposals()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€ã‚¹ãƒ†ãƒƒãƒ—1ã§å–å¾—ã—ãŸåœ¨åº«æƒ…å ±ã‚’ `inventory_items` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã€ã‚¹ãƒ†ãƒƒãƒ—2ã§å–å¾—ã—ãŸå±¥æ­´ã‚¿ã‚¤ãƒˆãƒ«ã‚’ `excluded_recipes` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹ã€‚
      
      **é‡è¦**: excluded_recipesãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å¿…ãš `"excluded_recipes": "task2.result.data"` ã¨æŒ‡å®šã—ã¦ãã ã•ã„ã€‚`"task2.result"`ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
   d. **task4**: `recipe_service.search_recipes_from_web()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€ã‚¹ãƒ†ãƒƒãƒ—3ã§å–å¾—ã—ãŸãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’ `recipe_titles` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹ã€‚

**ä¸¦åˆ—å®Ÿè¡Œã®æŒ‡ç¤º**: task2ã¨task3ã¯ä¸¦åˆ—ã§å®Ÿè¡Œå¯èƒ½ã§ã™ã€‚dependenciesã«task1ã®ã¿ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

4. **ä¸»èœè¿½åŠ ææ¡ˆã®å ´åˆï¼ˆPhase 1Fï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æ±‚ã«ã€Œã‚‚ã†5ä»¶ã€ã€Œã‚‚ã£ã¨ã€ã€Œä»–ã®ææ¡ˆã€ç­‰ã®è¿½åŠ ææ¡ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹å ´åˆã€ä»¥ä¸‹ã®4æ®µéšã®ã‚¿ã‚¹ã‚¯æ§‹æˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼š
   
   **èªè­˜ãƒ‘ã‚¿ãƒ¼ãƒ³**:
   - ã€Œã‚‚ã†5ä»¶ææ¡ˆã—ã¦ã€ã€Œã‚‚ã†5ä»¶æ•™ãˆã¦ã€
   - ã€Œã‚‚ã£ã¨ä»–ã®ä¸»èœã€ã€Œã‚‚ã£ã¨ææ¡ˆã—ã¦ã€ã€Œä»–ã®ææ¡ˆã‚’è¦‹ã‚‹ã€
   
   **å‰ææ¡ä»¶**:
   - ã€Œä¸»èœã€ã¨ã„ã†å˜èªãŒå«ã¾ã‚Œã‚‹
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒå­˜åœ¨ã™ã‚‹ï¼ˆsse_session_idï¼‰
   
   **ã‚¿ã‚¹ã‚¯æ§‹æˆ**:
   a. **task1**: `history_service.history_get_recent_titles(user_id, "main", 14)` ã‚’å‘¼ã³å‡ºã—ã€14æ—¥é–“ã®ä¸»èœå±¥æ­´ã‚’å–å¾—ã™ã‚‹ã€‚
   b. **task2**: `session_service.session_get_proposed_titles(sse_session_id, "main")` ã‚’å‘¼ã³å‡ºã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ææ¡ˆæ¸ˆã¿ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ã™ã‚‹ã€‚
      - **é‡è¦**: sse_session_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯ã€ä¸Šè¨˜ã®ã€Œç¾åœ¨ã®SSEã‚»ãƒƒã‚·ãƒ§ãƒ³IDã€ã®å€¤ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚æ±ºã—ã¦å›ºå®šå€¤ï¼ˆä¾‹: "session123"ï¼‰ã‚’ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
   c. **task3**: `recipe_service.generate_main_dish_proposals()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›:
      - `inventory_items`: æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¨ã—ã¦ "session.context.inventory_items" ã¨æŒ‡å®šï¼ˆã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—ï¼‰
      - `excluded_recipes`: "task1.result.data + task2.result.data"ï¼ˆå±¥æ­´ + ã‚»ãƒƒã‚·ãƒ§ãƒ³ææ¡ˆæ¸ˆã¿ï¼‰
      - `main_ingredient`: æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¨ã—ã¦ "session.context.main_ingredient" ã¨æŒ‡å®š
      - `menu_type`: æ–‡å­—åˆ—ãƒªãƒ†ãƒ©ãƒ«ã¨ã—ã¦ "session.context.menu_type" ã¨æŒ‡å®š
      - **é‡è¦**: inventory_itemsãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯çµ¶å¯¾ã« "session_inventory" ã¨ã„ã†åå‰ã‚’ä½¿ç”¨ã—ãªã„ã“ã¨
   d. **task4**: `recipe_service.search_recipes_from_web()` ã‚’å‘¼ã³å‡ºã™ã€‚ãã®éš›ã€task3ã§å–å¾—ã—ãŸãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’ `recipe_titles` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¨­å®šã™ã‚‹ã€‚
   
   **é‡è¦**: 
   - è¿½åŠ ææ¡ˆã®å ´åˆã€åœ¨åº«å–å¾—ã‚¿ã‚¹ã‚¯ï¼ˆinventory_service.get_inventoryï¼‰ã¯ç”Ÿæˆã—ãªã„ã§ãã ã•ã„ã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«ä¿å­˜ã•ã‚ŒãŸåœ¨åº«æƒ…å ±ã‚’å†åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚
   - session_get_proposed_titlesã®sse_session_idãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã¯ã€å¿…ãšãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«ç¤ºã•ã‚ŒãŸã€Œç¾åœ¨ã®SSEã‚»ãƒƒã‚·ãƒ§ãƒ³IDã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ³¨å…¥ã®ãƒ«ãƒ¼ãƒ«ï¼ˆè¿½åŠ ææ¡ˆå¯¾å¿œï¼‰**:
- å±¥æ­´é™¤å¤–ãƒªã‚¹ãƒˆ: `"excluded_recipes": "task1.result.data"`
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ææ¡ˆæ¸ˆã¿é™¤å¤–ãƒªã‚¹ãƒˆ: ä¸Šè¨˜ã«è¿½åŠ ã§ `+ task2.result.data`
- åœ¨åº«æƒ…å ±: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–å¾—ï¼ˆã‚¿ã‚¹ã‚¯ã§ã¯ãªãã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå‚ç…§ï¼‰
- ä¸»è¦é£Ÿæ: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–å¾—

**æ›–æ˜§æ€§è§£æ¶ˆå¾Œã®å‡¦ç†ï¼ˆPhase 1Eï¼‰**:
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›–æ˜§æ€§è§£æ¶ˆã®ãŸã‚ã®å›ç­”ã‚’æä¾›ã—ãŸå ´åˆ:
1. å…ƒã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã‚’çµ±åˆ
2. çµ±åˆã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã§é€šå¸¸ã®ã‚¿ã‚¹ã‚¯ãƒã‚§ãƒ¼ãƒ³ã‚’å®Ÿè¡Œ
3. ç¢ºèªçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢

ä¾‹:
- å…ƒã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ã€Œä¸»èœã‚’æ•™ãˆã¦ã€
- ç¢ºèªè³ªå•: ã€Œä½•ã‹é£Ÿæã‚’æŒ‡å®šã—ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚åœ¨åº«ã‹ã‚‰ææ¡ˆã—ã¾ã™ã‹ï¼Ÿã€
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”: ã€Œãƒ¬ãƒ³ã‚³ãƒ³ã§ãŠé¡˜ã„ã€
- çµ±åˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ: ã€Œãƒ¬ãƒ³ã‚³ãƒ³ã®ä¸»èœã‚’æ•™ãˆã¦ã€
- å®Ÿè¡Œ: 4ã‚¿ã‚¹ã‚¯ï¼ˆåœ¨åº«å–å¾—â†’å±¥æ­´å–å¾—â†’LLM+RAGçµ±åˆâ†’Webæ¤œç´¢ï¼‰

çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³:
- ã€Œä¸»èœã‚’æ•™ãˆã¦ã€+ã€Œãƒ¬ãƒ³ã‚³ãƒ³ã€â†’ã€Œãƒ¬ãƒ³ã‚³ãƒ³ã®ä¸»èœã‚’æ•™ãˆã¦ã€
- ã€Œä¸»èœã‚’æ•™ãˆã¦ã€+ã€Œåœ¨åº«ã‹ã‚‰ææ¡ˆã—ã¦ã€â†’ã€Œåœ¨åº«ã®ä¸­ã‹ã‚‰ä¸»èœã‚’æ•™ãˆã¦ã€(main_ingredient: null)
- ã€Œæ–™ç†ã‚’ææ¡ˆã—ã¦ã€+ã€Œé¶è‚‰ã€â†’ã€Œé¶è‚‰ã®æ–™ç†ã‚’ææ¡ˆã—ã¦ã€

**çŒ®ç«‹ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ãƒ«ãƒ¼ãƒ«**:
- task2ã¨task3ã®çµæœã¯è¾æ›¸å½¢å¼ã®çŒ®ç«‹ãƒ‡ãƒ¼ã‚¿ã§ã™ï¼ˆmain_dish, side_dish, soupãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ï¼‰
- task4ã§ã¯ã€task2ã¨task3ã®ä¸¡æ–¹ã®çµæœã‚’çµ±åˆã—ã¦ãƒ¬ã‚·ãƒ”æ¤œç´¢ã‚’è¡Œã£ã¦ãã ã•ã„ï¼š
  - `"recipe_titles": ["task2.result.main_dish", "task2.result.side_dish", "task2.result.soup", "task3.result.main_dish", "task3.result.side_dish", "task3.result.soup"]`
  - ã¾ãŸã¯ã€ä¸»èœã®ã¿: `"recipe_titles": ["task2.result.main_dish", "task3.result.main_dish"]`

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ³¨å…¥ã®ãƒ«ãƒ¼ãƒ«ï¼ˆé‡è¤‡å›é¿å¯¾å¿œï¼‰**:
- task1ã®çµæœã‚’task3ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ `"inventory_items": "task1.result"`
- task2ã®çµæœã‚’task3ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ **å¿…ãš** `"excluded_recipes": "task2.result.data"` **ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„**ï¼ˆé‡è¦: task2.resultã§ã¯ãªãtask2.result.dataã¨æŒ‡å®šï¼‰
- task3ã®çµæœã‚’task4ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ `"recipe_titles": "task3.result.candidates"`
- ä¸»è¦é£ŸæãŒã‚ã‚‹å ´åˆ â†’ `"main_ingredient": "æŠ½å‡ºã•ã‚ŒãŸé£Ÿæå"`
- ä¸»è¦é£ŸæãŒãªã„å ´åˆ â†’ `"main_ingredient": null`
- å…ˆè¡Œã‚¿ã‚¹ã‚¯ã®çµæœã‚’å¾Œç¶šã‚¿ã‚¹ã‚¯ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«æ³¨å…¥ã™ã‚‹å ´åˆã¯ã€å¿…ãš `"å…ˆè¡Œã‚¿ã‚¹ã‚¯å.result"` å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
- è¾æ›¸ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‚ç…§ã®å ´åˆã¯ `"å…ˆè¡Œã‚¿ã‚¹ã‚¯å.result.ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å"` å½¢å¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
- ä¾‹: task1ã®çµæœã‚’task2ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ `"inventory_items": "task1.result"`
- ä¾‹: task2ã®ä¸»èœã‚’task4ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ `"recipe_title": "task2.result.main_dish"`
- ä¾‹: task3ã®å€™è£œã‚’task4ã§ä½¿ç”¨ã™ã‚‹å ´åˆ â†’ `"recipe_titles": "task3.result.candidates"`
- ã“ã®å½¢å¼ã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«å…ˆè¡Œã‚¿ã‚¹ã‚¯ã®çµæœã‚’å¾Œç¶šã‚¿ã‚¹ã‚¯ã«æ³¨å…¥ã—ã¾ã™ã€‚

**åœ¨åº«æ“ä½œã®strategyåˆ¤å®šã«ã¤ã„ã¦**:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå¤ã„æ–¹ã€ã€Œæœ€æ–°ã€ã€Œå…¨éƒ¨ã€ãªã©ã‚’æ˜ç¤ºã—ãªã„é™ã‚Šã€`update_inventory` ã‚„ `delete_inventory` ã® `strategy` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ `'by_name'` ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

**strategyåˆ¤å®šã®é‡è¦ãƒ«ãƒ¼ãƒ«**:
1. **ã€Œå…¨éƒ¨ã€ã€Œã™ã¹ã¦ã€ã®åˆ¤å®š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã«ã€Œå…¨éƒ¨ã€ã€Œã™ã¹ã¦ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€èªé †ã«é–¢ä¿‚ãªã `strategy='by_name_all'` ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
2. **ã€Œå¤ã„ã€ã€Œæœ€æ–°ã€ã®åˆ¤å®š**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦æ±‚ã«ã€Œå¤ã„ã€ã€Œæœ€æ–°ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€è©²å½“ã™ã‚‹strategyã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
3. **æ›–æ˜§æ€§ã®åˆ¤å®š**: ä¸Šè¨˜ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯ `strategy='by_name'` ã‚’æŒ‡å®šã—ã€ã‚·ã‚¹ãƒ†ãƒ ãŒè‡ªå‹•çš„ã«æ›–æ˜§æ€§ã‚’æ¤œçŸ¥ã—ã¾ã™ã€‚

**åˆ¤å®šä¾‹**:
- ã€Œç‰›ä¹³ã‚’å…¨éƒ¨ï¼‘æœ¬ã«å¤‰ãˆã¦ã€â†’ ã€Œå…¨éƒ¨ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ â†’ `strategy='by_name_all'`
- ã€Œå…¨éƒ¨ã®ç‰›ä¹³ã‚’ï¼‘æœ¬ã«ã—ã¦ã€â†’ ã€Œå…¨éƒ¨ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ â†’ `strategy='by_name_all'`
- ã€Œç‰›ä¹³ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¦ã€â†’ ã€Œã™ã¹ã¦ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹ â†’ `strategy='by_name_all'`
- ã€Œç‰›ä¹³ã‚’ï¼‘æœ¬ã«å¤‰ãˆã¦ã€â†’ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãªã— â†’ `strategy='by_name'` (ã‚·ã‚¹ãƒ†ãƒ ãŒæ›–æ˜§æ€§ã‚’æ¤œçŸ¥)

**âš ï¸ é‡è¦: ã€Œå¤‰ãˆã¦ã€ã®èªè­˜ãƒ«ãƒ¼ãƒ«**:
- ã€Œå¤‰ãˆã¦ã€ã€Œå¤‰æ›´ã—ã¦ã€ã€Œä¿®æ­£ã—ã¦ã€ç­‰ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯**å¿…ãšæ›´æ–°æ“ä½œ**ã¨ã—ã¦èªè­˜ã—ã¦ãã ã•ã„
- ã€Œå¤‰ãˆã¦ã€è¦æ±‚ã«å¯¾ã—ã¦**å‰Šé™¤+è¿½åŠ ã®çµ„ã¿åˆã‚ã›ã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„ã§ãã ã•ã„**
- ã€Œå¤‰ãˆã¦ã€ã¯æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã®æ•°é‡ã‚„å±æ€§ã‚’å¤‰æ›´ã™ã‚‹æ“ä½œã§ã‚ã‚Šã€æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã®è¿½åŠ ã§ã¯ã‚ã‚Šã¾ã›ã‚“

**strategyåˆ¤å®šã®ä¾‹**:
- ã€Œç‰›ä¹³ã‚’æ›´æ–°/å‰Šé™¤ã—ã¦ã€ â†’ `strategy='by_name'` (ã‚·ã‚¹ãƒ†ãƒ ãŒæ›–æ˜§æ€§ã‚’æ¤œçŸ¥)
- ã€Œå¤ã„ç‰›ä¹³ã‚’æ›´æ–°/å‰Šé™¤ã—ã¦ã€ â†’ `strategy='by_name_oldest'` (æœ€å¤)
- ã€Œæœ€æ–°ã®ç‰›ä¹³ã‚’æ›´æ–°/å‰Šé™¤ã—ã¦ã€ â†’ `strategy='by_name_latest'` (æœ€æ–°)
- ã€Œå…¨éƒ¨ã®ç‰›ä¹³ã‚’æ›´æ–°/å‰Šé™¤ã—ã¦ã€ â†’ `strategy='by_name_all'` (å…¨éƒ¨)

**ã€Œå¤‰ãˆã¦ã€ã®å…·ä½“ä¾‹ï¼ˆæ›´æ–°æ“ä½œï¼‰**:
- ã€Œæœ€æ–°ã®ç‰›ä¹³ã‚’5æœ¬ã«å¤‰ãˆã¦ã€ â†’ `inventory_service.update_inventory(item_identifier='ç‰›ä¹³', updates={{'quantity': 5}}, strategy='by_name_latest')`
- ã€Œä¸€ç•ªå¤ã„ãƒ”ãƒ¼ãƒãƒ³ã‚’3å€‹ã«å¤‰ãˆã¦ã€ â†’ `inventory_service.update_inventory(item_identifier='ãƒ”ãƒ¼ãƒãƒ³', updates={{'quantity': 3}}, strategy='by_name_oldest')`
- ã€Œç‰›ä¹³ã®ä¿å­˜å ´æ‰€ã‚’å†·å‡åº«ã«å¤‰ãˆã¦ã€ â†’ `inventory_service.update_inventory(item_identifier='ç‰›ä¹³', updates={{'storage_location': 'å†·å‡åº«'}}, strategy='by_name')`
- ã€Œå¤ã„ç‰›ä¹³ã®å˜ä½ã‚’ãƒ‘ãƒƒã‚¯ã«å¤‰ãˆã¦ã€ â†’ `inventory_service.update_inventory(item_identifier='ç‰›ä¹³', updates={{'unit': 'ãƒ‘ãƒƒã‚¯'}}, strategy='by_name_oldest')`

**âŒ ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã€Œå¤‰ãˆã¦ã€è¦æ±‚ã«å¯¾ã—ã¦ï¼‰**:
- ã€Œå¤‰ãˆã¦ã€è¦æ±‚ã§ `delete_inventory` + `add_inventory` ã®çµ„ã¿åˆã‚ã›ã¯çµ¶å¯¾ã«ç”Ÿæˆã—ãªã„
- ã€Œå¤‰ãˆã¦ã€è¦æ±‚ã§è¤‡æ•°ã‚¿ã‚¹ã‚¯ã«åˆ†è§£ã—ãªã„ï¼ˆå¿…ãš1ã¤ã® `update_inventory` ã‚¿ã‚¹ã‚¯ã®ã¿ï¼‰

**å‡ºåŠ›å½¢å¼**: å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¯ç¦æ­¢ï¼‰ï¼š

{{
    "tasks": [
        {{
            "id": "task1",
            "description": "ã‚¿ã‚¹ã‚¯ã®è‡ªç„¶è¨€èªã§ã®èª¬æ˜",
            "service": "å‘¼ã³å‡ºã™ã‚µãƒ¼ãƒ“ã‚¹å",
            "method": "å‘¼ã³å‡ºã™ãƒ¡ã‚½ãƒƒãƒ‰å",
            "parameters": {{ "key": "value" }},
            "dependencies": []
        }}
    ]
}}

**çŒ®ç«‹ç”Ÿæˆã®å…·ä½“ä¾‹ï¼ˆã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰åå¯¾å¿œï¼‰**:
{{
    "tasks": [
        {{
            "id": "task1",
            "description": "ç¾åœ¨ã®å…¨åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒªã‚¹ãƒˆã‚’å–å¾—ã™ã‚‹",
            "service": "inventory_service",
            "method": "get_inventory",
            "parameters": {{}},
            "dependencies": []
        }},
        {{
            "id": "task2",
            "description": "åœ¨åº«ãƒªã‚¹ãƒˆã«åŸºã¥ãã€LLMã«ã‚ˆã‚‹ç‹¬å‰µçš„ãªçŒ®ç«‹ã‚’ææ¡ˆã™ã‚‹",
            "service": "recipe_service",
            "method": "generate_menu_plan",
            "parameters": {{ "inventory_items": "task1.result", "user_id": "user123" }},
            "dependencies": ["task1"]
        }},
        {{
            "id": "task3",
            "description": "åœ¨åº«ãƒªã‚¹ãƒˆã«åŸºã¥ãã€RAGã‚’ä½¿ç”¨ã—ã¦éå»ã®çŒ®ç«‹å±¥æ­´ã‹ã‚‰é¡ä¼¼çŒ®ç«‹ã‚’æ¤œç´¢ã™ã‚‹",
            "service": "recipe_service",
            "method": "search_menu_from_rag",
            "parameters": {{ "inventory_items": "task1.result", "user_id": "user123" }},
            "dependencies": ["task1"]
        }},
        {{
            "id": "task4",
            "description": "ææ¡ˆã•ã‚ŒãŸçŒ®ç«‹ã®ãƒ¬ã‚·ãƒ”ã‚’Webæ¤œç´¢ã—ã¦è©³ç´°æƒ…å ±ã‚’å–å¾—ã™ã‚‹",
            "service": "recipe_service",
            "method": "search_recipes_from_web",
            "parameters": {{ 
                "recipe_titles": ["task2.result.main_dish", "task2.result.side_dish", "task2.result.soup", "task3.result.main_dish", "task3.result.side_dish", "task3.result.soup"],
                "menu_categories": ["main_dish", "side_dish", "soup", "main_dish", "side_dish", "soup"],
                "menu_source": "mixed",
                "num_results": 3
            }},
            "dependencies": ["task2", "task3"]
        }}
    ]
}}

**ä¾å­˜é–¢ä¿‚ã®ãƒ«ãƒ¼ãƒ«**:
- å„ã‚¿ã‚¹ã‚¯ã«ã¯ä¸€æ„ã®IDï¼ˆtask1, task2, ...ï¼‰ã‚’ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚
- `dependencies` ã«ã¯ã€å®Ÿè¡Œå‰ã«å®Œäº†ã—ã¦ã„ã‚‹ã¹ãã‚¿ã‚¹ã‚¯ã®IDã‚’ãƒªã‚¹ãƒˆã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
- ä¾å­˜é–¢ä¿‚ãŒãªã„å ´åˆã¯ç©ºé…åˆ— `[]` ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

**æŒ¨æ‹¶ã‚„ä¸€èˆ¬çš„ãªä¼šè©±ã®å ´åˆ**:
- ã‚¿ã‚¹ã‚¯ã¯ç”Ÿæˆã›ãšã€ç©ºã®é…åˆ— `{{"tasks": []}}` ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
"""
        return planning_prompt
    
    def create_dynamic_prompt(
        self, 
        base_prompt: str, 
        tool_descriptions: str,
        user_context: Dict[str, Any]
    ) -> str:
        """
        å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
        
        Args:
            base_prompt: ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            tool_descriptions: ãƒ„ãƒ¼ãƒ«èª¬æ˜
            user_context: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        
        Returns:
            å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        """
        try:
            self.logger.info(f"ğŸ”§ [PromptManager] Creating dynamic prompt")
            
            # å‹•çš„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
            dynamic_prompt = f"""
{base_prompt}

{tool_descriptions}

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: {user_context.get('user_id', 'N/A')}
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ID: {user_context.get('session_id', 'N/A')}
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»: {user_context.get('timestamp', 'N/A')}
"""
            
            self.logger.info(f"âœ… [PromptManager] Dynamic prompt created successfully")
            
            return dynamic_prompt
            
        except Exception as e:
            self.logger.error(f"âŒ [PromptManager] Error in create_dynamic_prompt: {e}")
            return base_prompt
