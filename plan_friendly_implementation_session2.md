# ヘルプ機能実装計画 - セッション2（仕上げとフロントエンド）

## 概要

セッション1で実装したバックエンドのコア機能を仕上げ、フロントエンドとの統合を完了します。

**セッション2の目標**: 精度向上、フロントエンド対応、統合テスト

---

## 前提条件

セッション1で以下が完了していること：
- ✅ ヘルプハンドラの作成
- ✅ セッション状態管理の拡張
- ✅ TrueReactAgentへのヘルプ検知機能の基本実装

---

## 実装計画（セッション2）

### 1. ヘルプキーワード検知の精度向上

**修正する場所**: `/app/Morizo-aiv2/core/agent.py` の `_is_help_keyword()` メソッド

**修正する内容**:

セッション1で実装した基本的なキーワード検知を、誤検知を防ぐ精度の高い実装に改善：

```python
def _is_help_keyword(self, user_request: str) -> bool:
    """ヘルプキーワードを検知（誤検知防止）"""
    help_keywords = [
        "使い方を教えて",
        "使い方を知りたい",
        "使い方を説明して",
        "ヘルプ",
        "help"
    ]
    
    user_request_lower = user_request.strip().lower()
    
    # 「使い方を教えて」などの明確な表現のみ検知
    # 「使い方」だけでは検知しない（誤検知防止）
    for keyword in help_keywords:
        if keyword in user_request_lower:
            # 「使い方」単独の場合は、前後に特定の文字がある場合のみ検知
            if keyword == "使い方":
                # 「使い方を」や「使い方は」などの完全一致を要求
                patterns = ["使い方を", "使い方は", "使い方について", "使い方って", "使い方 教えて"]
                if not any(pattern in user_request_lower for pattern in patterns):
                    continue
            return True
    
    return False
```

**修正の理由**: 
- セッション1の基本実装では「使い方」という単語だけでも検知される可能性がある
- より精度の高い検知で誤検知を防ぐ

**修正の影響**: 
- `_is_help_keyword()`メソッドの改善のみ（既存機能への影響なし）

---

### 2. フロントエンドのプレースホルダー変更

**修正する場所**: `/app/Morizo-web/components/ChatInput.tsx` の39行目

**修正する内容**:

```tsx
// 変更前
placeholder="メッセージを入力してください..."

// 変更後
placeholder="メッセージを入力してください...または 使い方を教えて..."
```

**修正の理由**: 
- ヘルプ機能の存在をユーザーに案内するため
- ユーザーがヘルプ機能を発見しやすくする

**修正の影響**: 
- プレースホルダーテキストの変更のみ（機能への影響なし）

---

### 3. 動作確認と統合テスト

**確認項目**:

#### 3-1: ヘルプ全体概要の表示
- [ ] 「使い方を教えて」で全体概要が表示されること
- [ ] セッション状態が `help_state: "overview"` になること
- [ ] プレースホルダーにヘルプ案内が表示されること

#### 3-2: 機能別詳細の表示
- [ ] 「1」で在庫管理機能の詳細が表示されること
- [ ] 「2」で献立一括提案の詳細が表示されること
- [ ] 「3」で段階的提案の詳細が表示されること
- [ ] 「4」で補助機能の詳細が表示されること
- [ ] 各詳細表示時にセッション状態が正しく更新されること

#### 3-3: ヘルプキーワードの検知（精度確認）
- [ ] 「使い方を教えて」で検知されること
- [ ] 「使い方」だけでは検知されないこと（誤検知防止）
- [ ] 「使い方を」で検知されること
- [ ] 「使い方は」で検知されること
- [ ] 「使い方について」で検知されること
- [ ] 「使い方って」で検知されること
- [ ] 「使い方 教えて」で検知されること
- [ ] 「在庫の使い方」では検知されないこと（誤検知防止）
- [ ] 「ヘルプ」で検知されること
- [ ] 「help」で検知されること

#### 3-4: 通常のチャットへの復帰
- [ ] ヘルプモード中に通常のチャット入力で自動的に復帰すること
- [ ] 復帰時にセッション状態が `help_state: null` になること
- [ ] 復帰後、通常のタスク処理が正常に動作すること

#### 3-5: セッション状態の管理
- [ ] ヘルプ状態が正しく保存・取得されること
- [ ] セッションがない場合でもヘルプが動作すること（応答は返す）
- [ ] 複数の機能詳細を順番に見た場合、状態が正しく更新されること

#### 3-6: エッジケース
- [ ] 無効な数字（5以上、0、負の数）を入力した場合の動作
- [ ] 空白のみのメッセージの動作
- [ ] セッションがタイムアウトした場合の動作

---

## ユーザー体験フロー（最終確認）

### シナリオ1: 初めてヘルプを使う

1. ユーザー: 「使い方を教えて」
2. システム: 全体概要を表示（`help_state: "overview"`）
3. ユーザー: 「1」
4. システム: 在庫管理機能の詳細を表示（`help_state: "detail_1"`）
5. ユーザー: 「在庫を教えて」（通常のチャット入力）
6. システム: ヘルプモードを終了して通常処理を実行（`help_state: null`）

### シナリオ2: ヘルプから通常のチャットに復帰

1. ユーザー: 「使い方を教えて」
2. システム: 全体概要を表示（`help_state: "overview"`）
3. ユーザー: 「大根を１本追加して」（通常のチャット入力）
4. システム: ヘルプモードを自動的に終了し、在庫追加処理を実行（`help_state: null`）

### シナリオ3: 複数の機能詳細を順番に見る

1. ユーザー: 「使い方を教えて」
2. システム: 全体概要を表示（`help_state: "overview"`）
3. ユーザー: 「1」
4. システム: 在庫管理機能の詳細を表示（`help_state: "detail_1"`）
5. ユーザー: 「2」
6. システム: 献立一括提案の詳細を表示（`help_state: "detail_2"`）

### シナリオ4: 誤検知防止の確認

1. ユーザー: 「在庫の使い方を教えて」（通常のチャット入力）
2. システム: ヘルプではなく、通常の在庫操作として処理される

---

## 実装順序

1. **修正1**: ヘルプキーワード検知の精度向上
2. **修正2**: フロントエンドのプレースホルダー変更
3. **修正3**: 動作確認と統合テスト

---

## テスト項目（セッション2）

### バックエンド（精度向上の確認）

1. **ヘルプキーワードの検知（精度確認）**
   - 全ての検知対象キーワードで正しく検知されること
   - 誤検知パターンが正しく除外されること
   - エッジケースでの動作が適切であること

### フロントエンド

1. **プレースホルダーの表示**
   - 新しいプレースホルダーが正しく表示されること
   - 既存の機能に影響がないこと

### 統合テスト

1. **エンドツーエンドの動作確認**
   - 全てのシナリオが正常に動作すること
   - セッション状態が正しく管理されること
   - 通常のチャット機能に影響がないこと

---

## 注意事項（セッション2）

1. **誤検知防止の徹底**: 精度向上の実装で、誤検知が完全に排除されることを確認する

2. **フロントエンドの確認**: プレースホルダー変更後、他の機能に影響がないことを確認する

3. **既存機能への影響**: 全ての変更が既存機能に影響を与えないことを確認する

4. **ログ出力**: ヘルプモードの全ての遷移がログに記録されることを確認する

5. **エラーハンドリング**: 異常系の動作も確認する

---

## 完了基準

セッション2完了時点で以下が満たされること：

- ✅ ヘルプキーワード検知の精度が向上し、誤検知が排除されている
- ✅ フロントエンドのプレースホルダーが更新されている
- ✅ 全てのテスト項目がパスしている
- ✅ エンドツーエンドの動作確認が完了している
- ✅ 既存機能への影響がないことを確認している

---

## 追加の改善案（将来の拡張）

1. **ヘルプ履歴**: ユーザーが見たヘルプの履歴を保存し、よく見る部分を優先表示

2. **検索機能**: ヘルプ内容を検索できる機能

3. **ショートカット**: 「1」だけでなく「在庫」「献立」などのキーワードでも詳細に遷移

4. **コンテキストヘルプ**: エラー発生時や特定の状況で、関連するヘルプを自動表示

---

## まとめ

- **実装ファイル数**: 2ファイル修正（バックエンド1、フロントエンド1）
- **ヘルプ階層数**: 2階層（全体概要 → 機能別詳細）
- **ユーザー体験**: 段階的で自然なヘルプの掘り下げ
- **誤検知防止**: 明確なキーワード判定で実現
- **柔軟性**: 通常のチャット入力でいつでも復帰可能

