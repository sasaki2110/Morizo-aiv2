# Phase 4: タスクチェーンのロールバック機能

## 概要

Phase 3で実装した段階的選択システム（主菜→副菜→汁物）において、ユーザーが選択に満足できない場合に前の段階に戻れるロールバック機能を実装します。

## 現状の問題点

### 異常な状況

- 副菜の提案が気に入らない場合、主菜選定に戻れない
- 汁物の提案が気に入らない場合、副菜・主菜選定に戻れない
- **戻り機能が実装されていない**

## 解決策

### 実装すべき機能

1. **ロールバック要求の検出**: ユーザーが「戻る」や「前の段階に戻る」と言った場合、またはフロントエンドからの明示的な要求
2. **タスクチェーンのロールバック**: 完了したタスクをRUNNING状態に戻し、結果をクリア（※現時点では、次回リクエスト時に新規タスクチェーン生成を期待）
3. **セッション状態のロールバック**: 選択履歴をクリアし、段階を戻す
4. **ロールバック後の再実行**: ロールバック後は次回のリクエスト時に新規タスクチェーンが生成されることを期待（再実行機能は将来の拡張として検討）
5. **フロントエンド連携**: 「戻る」ボタンを追加し、ロールバック要求を送信

## Phase 4の全体構成

### **Phase 4A: バックエンドロールバック機能の実装**

- ロールバック要求の検出機能
- タスクチェーンのロールバック機能（TaskChainManager拡張）
- セッション状態のロールバック機能（SessionService拡張）
- 基本的なテスト

**注意**: ロールバック後のタスク再実行は、次回のリクエスト時に新規タスクチェーンが生成されることを期待します。現時点ではタスクチェーンの再実行機能は実装しません。

### **Phase 4B: フロントエンド連携**

- 「戻る」ボタンの追加
- ロールバック要求の送信機能
- UIの状態管理
- 統合テスト

## 実装順序

1. **Phase 4A** → バックエンドロールバック機能の実装
2. **Phase 4B** → フロントエンド連携の実装

## 詳細プラン

各フェーズの詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_4A.md](./plan_Phase_4A.md) - バックエンドロールバック機能の実装
- [plan_Phase_4B.md](./plan_Phase_4B.md) - フロントエンド連携の実装

## 期待される効果

- ユーザーが選択に満足できない場合に前の段階に戻れる
- より柔軟な献立作成が可能になる
- ユーザー体験が向上する

## 制約事項

- Phase 4Aが完成してからPhase 4Bを開始
- 既存のPhase 1-3の機能を破壊しない
- ロールバックは1段階ずつ（副菜→主菜、汁物→副菜）
- 複数段階の一括ロールバックは実装しない（将来の拡張として検討）

## 技術的な考慮事項

### タスクチェーンのロールバック

- COMPLETEDタスクをRUNNINGに戻す
- 以降のタスクをPENDINGに戻す
- タスクの結果をクリア
- 依存関係を適切に管理

### セッション状態のロールバック

- 選択履歴のクリア（該当段階以降）
- used_ingredientsの更新
- current_stageの更新
- 提案履歴の管理

### エラーハンドリング

- ロールバック対象タスクが見つからない場合
- セッション状態が不整合な場合
- ロールバック後の再実行時のエラー処理

詳しい技術的な実装については、[plan_Phase_4A.md](./plan_Phase_4A.md)と[plan_Phase_4B.md](./plan_Phase_4B.md)を参照してください。

