# Phase 1: 主菜5件提案機能の追加（分割版）

## 概要

主菜5件提案機能を4つのフェーズに分割して実装します。Phase 1Aで基本機能、Phase 1Bでプランナー・タスク設計拡張、Phase 1Cで統合テストを実施します。

## 分割構成

### Phase 1A: 基本機能実装
- LLM推論で主菜2件生成（主要食材考慮、重複回避）
- RAG検索で主菜3件検索（主要食材考慮、重複回避）
- MCP統合レイヤー（LLM + RAG統合）
- レスポンスフォーマッター（5件表示）
- レスポンス処理統合
- 履歴取得機能（重複回避用）

### Phase 1B: プランナー・タスク設計拡張
- プランナープロンプトの更新（新ツール認識、重複回避対応）
- 動的タスク構築機能
- コンテキスト管理（主要食材保存）
- 曖昧性検出の拡張（主要食材未指定時の柔軟な選択肢提示）
- 履歴取得タスクの追加（重複回避用）

### Phase 1C: 基本統合テスト
- Phase 1A + Phase 1Bの基本統合テスト
- ユーザー要求から5件提案までの一連の流れ確認
- 主要食材指定・未指定の両方のケース
- 曖昧性検出・確認プロセスの動作確認
- エラーハンドリングの確認
- 基本パフォーマンステスト

### Phase 1D: 重複回避機能テスト
- 履歴取得機能のテスト
- MCPツール統合テスト
- LLM/RAG除外機能テスト
- 重複回避機能の統合テスト
- 4段階タスク構成テスト
- 重複回避パフォーマンステスト

### Phase 1E: 曖昧性解消後の再開機能
- セッション状態管理の拡張（確認待ち状態の保存）
- ユーザー回答の受付機能
- コンテキスト統合機能（元のリクエスト + ユーザー回答）
- タスクチェーンの再開機能
- プランナープロンプトの拡張
- エラーハンドリング

### Phase 1F: 主菜追加提案機能（もう5件提案）
- セッション内での提案履歴管理
- `selection=0`を追加提案リクエストとして認識（agent.py拡張）
- セッション提案履歴取得MCPツール
- 除外リストの構成（履歴14日分 + セッション内提案済み）
- 在庫情報の再利用（セッション保存）
- フロントエンド「他の提案を見る」ボタン連携（既に実装済み）

## 実装順序

1. **Phase 1A** → 基本機能の実装
2. **Phase 1B** → プランナー・タスク設計の拡張
3. **Phase 1C** → 基本統合テストと品質保証
4. **Phase 1D** → 重複回避機能テストと品質保証
5. **Phase 1E** → 曖昧性解消後の再開機能と品質保証
6. **Phase 1F** → 主菜追加提案機能（もう5件提案）

## 詳細プラン

各フェーズの詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_1A.md](./plan_Phase_1A.md) - 基本機能実装
- [plan_Phase_1B.md](./plan_Phase_1B.md) - プランナー・タスク設計拡張
- [plan_Phase_1C.md](./plan_Phase_1C.md) - 基本統合テスト
- [plan_Phase_1D.md](./plan_Phase_1D.md) - 重複回避機能テスト
- [plan_Phase_1E.md](./plan_Phase_1E.md) - 曖昧性解消後の再開機能
- [plan_Phase_1F.md](./plan_Phase_1F.md) - 主菜追加提案機能（もう5件提案）

## 期待される効果

- ユーザーが主菜を選ぶ選択肢が増える（2件→5件）
- LLMの独創性とRAGの伝統的レシピのバランスが取れる
- **主要食材を考慮した提案でユーザーの意図に沿った提案**
- **曖昧性検出によりユーザー体験が向上**
- Phase 2以降の段階的選択システムの基盤となる

## 制約事項

- Phase 1Aが完成してからPhase 1Bを開始
- Phase 1Bが完成してからPhase 1Cを開始
- Phase 1Cが完成してからPhase 1Dを開始
- フロントエンドは既存の表示機能で対応（Phase 2で専用UI追加予定）
- ユーザー選択機能は含まない（Phase 2で追加予定）
- 副菜・汁物は現状維持（Phase 3以降で対応予定）

## Phase 2: ユーザー選択機能の実装

### Phase 2A: バックエンド基盤の実装
- タスクの一時停止・再開機能
- 選択結果受付機能
- 状態管理機能
- API設計の拡張
- 基本的なテスト

### Phase 2B: フロントエンド連携の実装
- ユーザー選択UIコンポーネント
- 選択結果送信機能
- リアルタイム通信機能
- 状態管理の拡張
- ユーザー体験の改善

### Phase 2C: 統合テストと品質保証
- エンドツーエンドテスト
- パフォーマンステスト
- ユーザー体験テスト
- エラーハンドリングテスト
- セキュリティテスト
- 品質保証レポート

## 実装順序

1. **Phase 2A** → バックエンド基盤の実装
2. **Phase 2B** → フロントエンド連携の実装
3. **Phase 2C** → 統合テストと品質保証

## 詳細プラン

各フェーズの詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_2A.md](./plan_Phase_2A.md) - バックエンド基盤の実装
- [plan_Phase_2B.md](./plan_Phase_2B.md) - フロントエンド連携の実装
- [plan_Phase_2C.md](./plan_Phase_2C.md) - 統合テストと品質保証

## 期待される効果

- ユーザーが視覚的に選択肢を確認できる
- 選択操作が直感的で使いやすい
- リアルタイム通信でレスポンスが向上
- 段階的選択システムの基盤が完成
- Phase 3以降の副菜・汁物選択機能の基盤となる

## 制約事項

- Phase 2Aが完成してからPhase 2Bを開始
- Phase 2Bが完成してからPhase 2Cを開始
- 既存のPhase 1の機能を破壊しない
- フロントエンドは既存のチャット機能を拡張
- 副菜・汁物の段階的選択は含まない（Phase 3で追加予定）
- タスクチェーンのロールバックは含まない（Phase 4で追加予定）

### **今後の拡張**
✅ **Phase 3**: 副菜・汁物の段階的選択（[plan_Phase_3.md](./plan_Phase_3.md)）
🔜 **Phase 4**: タスクチェーンのロールバック（plan_Phase_4.md 作成が必要）  
🔜 **Phase 5**: 履歴管理（plan_Phase_5.md 作成が必要）

## Phase 3: 副菜・汁物の段階的選択

### Phase 3A: バックエンド汎用メソッドの実装
- LLM層の汎用メソッド追加（category対応）
- RAG層の汎用メソッド追加（category対応）
- MCP層の汎用メソッド追加（category対応）

### Phase 3B: プランナーの拡張
- 副菜・汁物提案のタスク生成ルール追加
- 段階的タスクチェーンの構築

### Phase 3C: 自動遷移機能（3つに分割）
- **Phase 3C-1**: セッション管理の拡張
- **Phase 3C-2**: 段階判定機能
- **Phase 3C-3**: 自動遷移機能

### Phase 3D: フロントエンド対応
- 段階表示の追加
- 選択履歴の表示

### Phase 3E: 統合テスト
- エンドツーエンドテスト
- 段階的選択の動作確認

## 実装順序

1. **Phase 3A** → バックエンド汎用メソッドの実装
2. **Phase 3B** → プランナーの拡張
3. **Phase 3C-1** → セッション管理の拡張
4. **Phase 3C-2** → 段階判定機能
5. **Phase 3C-3** → 自動遷移機能
6. **Phase 3D** → フロントエンド対応
7. **Phase 3E** → 統合テスト

## 詳細プラン

詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_3.md](./plan_Phase_3.md) - 副菜・汁物の段階的選択
