# Morizo AI v2 - 原理原則と最終ゴール

## 📋 概要

**作成日**: 2025年1月29日  
**バージョン**: 1.0  
**目的**: スクラップ＆ビルドによる再構築の基本原理と最終目標の明確化

> **注意**: このドキュメントは技術的な原理原則を定義します。  
> **要件定義とユーザー体験については `01_REQUIREMENTS_AND_USER_EXPERIENCE.md` を参照してください。**

## 🧠 原理原則

### **1. 疎結合設計の徹底**
- **本体のシンプル性**: エージェント機能に特化した汎用的な作り
- **MCP外付け拡張**: 外部連携や追加機能はMCPとして外付けで拡張
- **単独動作保証**: 各MCPは単独での動作を保証
- **相互独立性**: 本体やMCP間の密結合を完全に排除

### **2. 責任分離の徹底**
- **単一責任原則**: 各モジュールは明確な単一の責任を持つ
- **依存関係の明確化**: タスク間の依存関係を明確に定義
- **循環参照の回避**: MCPツールからMCPツールへの直接呼び出しを禁止
- **データフローの透明性**: 入力・出力・依存関係を明確に文書化

### **3. AIネイティブ設計**
- **手動処理の排除**: ハードコーディングされた処理を完全に排除
- **LLM/RAG制約解決**: AI制約解決エンジンによる統一的な処理
- **動的ツール選択**: MCPから動的に取得したツールリストから適切なツールを選択
- **プロンプト特化**: 本体プロンプトはエージェント機能・タスク制御に特化

### **4. ファイルサイズ制限**
- **コア機能**: 各ファイル150行以下
- **サービス層**: 各ファイル100行以下
- **MCP層**: 各ファイル100行以下
- **API層**: 各ファイル100行以下

## 🎯 最終ゴール

### **機能目標**
1. **統一されたReActエージェント**: 単純・複雑問わず同じフローで処理
2. **在庫管理システム**: FIFO原則による効率的な在庫管理
3. **レシピ提案システム**: 食材重複回避 + 2週間重複回避
4. **セッション管理**: メモリ内セッション管理
5. **MCP統合**: 疎結合なMCPツール通信

### **技術目標**
1. **コンテキストウインドウ最適化**: 各ファイルの責任を明確化
2. **テスト最小限**: 基本動作確認のみの軽量テスト
3. **段階的構築**: コア → サービス → MCP → APIの順序で構築
4. **既存コード参照なし**: 設計思想のみを基にした実装

### **品質目標**
1. **保守性**: 各モジュールが独立して変更可能
2. **拡張性**: 新しい機能を独立して追加可能
3. **再利用性**: 他のプロジェクトでも利用可能
4. **デバッグ容易性**: 問題の特定が容易

## 🏗️ アーキテクチャ原則

### **層別アーキテクチャ**
```
┌─────────────────┐
│   API Layer     │ ← 100行以下
├─────────────────┤
│  Service Layer  │ ← 100行以下
├─────────────────┤
│   MCP Layer     │ ← 100行以下
├─────────────────┤
│   Core Layer    │ ← 150行以下
└─────────────────┘
```

### **データフロー原則**
1. **上から下への依存**: 上位層のみが下位層に依存
2. **横方向の依存禁止**: 同層間の直接依存を禁止
3. **循環依存の排除**: どの層でも循環依存を禁止
4. **インターフェース分離**: 明確なAPI設計

### **エラーハンドリング原則**
1. **階層別エラー処理**: 各層で適切なエラー処理
2. **エラー伝播の制御**: 下位層のエラーを上位層で適切に処理
3. **ログ出力の統一**: 階層別のログ出力形式
4. **回復可能性**: 可能な限りエラーからの回復を実装

## 🚀 実装戦略

### **Phase 1: ロギング戦略**
- 基本的なロギング設定
- 階層別ログ出力
- ログローテーション機能

### **Phase 2: コア機能**
- TrueReactAgent（統一エージェント）
- ActionPlanner（タスク計画）
- TaskExecutor（タスク実行）

### **Phase 3: サービス層**
- RecipeService（レシピ関連サービス）
- InventoryService（在庫管理サービス）
- SessionService（セッション管理サービス）

### **Phase 4: MCP層**
- InventoryMCP（在庫管理MCP - `inventory`テーブルのCRUD）
- RecipeHistoryMCP（レシピ履歴MCP - `recipe_historys`テーブルのCRUD）
- RecipeMCP（レシピ提案MCP）

### **Phase 5: API層**
- FastAPIアプリケーション
- ルート定義
- ミドルウェア

## 📊 成功基準

### **機能面**
- [ ] 統一されたReActエージェントの動作確認
- [ ] 在庫管理機能の動作確認
- [ ] レシピ提案機能の動作確認
- [ ] セッション管理機能の動作確認
- [ ] MCP統合機能の動作確認

### **技術面**
- [ ] 全ファイルがサイズ制限内
- [ ] 循環依存の排除
- [ ] 責任分離の徹底
- [ ] 疎結合設計の実現
- [ ] テストの最小限実装

### **品質面**
- [ ] 各モジュールの独立動作確認
- [ ] デバッグの容易性確認
- [ ] 拡張性の確認
- [ ] 保守性の確認

## 🔄 継続的改善

### **設計レビュー**
- 各Phase完了時の設計レビュー
- 原理原則の遵守確認
- アーキテクチャの一貫性確認

### **コードレビュー**
- ファイルサイズ制限の遵守
- 責任分離の徹底確認
- 疎結合設計の実現確認

### **テストレビュー**
- 基本動作確認の実施
- エラーハンドリングの確認
- パフォーマンスの確認

---

**このドキュメントは、Morizo AI v2の再構築における基本原理と最終目標を定義します。**
**すべての実装は、この原理原則に基づいて行われます。**
