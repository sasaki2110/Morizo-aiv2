# Phase 3: 副菜・汁物の段階的選択機能の実装

## 概要

Phase 3では、主菜選択後に自動的に副菜・汁物の提案を行う段階的選択システムを実装します。
主菜→副菜→汁物の順でユーザーが選択できるようになります。

## 現状の問題点

### **異常な状況**
- 主菜を選んだ後、次のアクションが無い
- 副菜・汁物は主菜に連動して決めるべきなのに独立している
- **段階的選択の流れがない**

## 解決策

### **実装すべき機能**
1. **副菜提案機能**: 主菜で使っていない食材で副菜を5件提案
2. **汁物提案機能**: 主菜・副菜で使っていない食材で汁物を5件提案
3. **自動遷移**: 主菜選択後→副菜提案、副菜選択後→汁物提案
4. **カテゴリ連動**: 主菜が和食なら副菜も和食、汁物は味噌汁

---

## Phase 3の全体構成

### **Phase 3A: バックエンド汎用メソッドの実装**
- LLM層の汎用メソッド追加
- RAG層の汎用メソッド追加
- MCP層の汎用メソッド追加

**詳細**: [plan_Phase_3A.md](./plan_Phase_3A.md)

### **Phase 3B: プランナーの拡張**
- 副菜・汁物提案のタスク生成ルール追加
- 段階的タスクチェーンの構築
- カテゴリ連動の実装

**詳細**: [plan_Phase_3B.md](./plan_Phase_3B.md)

### **Phase 3C: 自動遷移機能（3つに分割）**

#### **Phase 3C-1: セッション管理の拡張**
- Sessionにstageフィールド追加
- 選択履歴の保存

**詳細**: [plan_Phase_3C_1.md](./plan_Phase_3C_1.md)

#### **Phase 3C-2: 段階判定機能**
- 現在の段階を取得
- 次の段階を判定

**詳細**: [plan_Phase_3C_2.md](./plan_Phase_3C_2.md)

#### **Phase 3C-3: 自動遷移機能**
- 次のリクエスト生成
- タスクチェーン自動実行

**詳細**: [plan_Phase_3C_3.md](./plan_Phase_3C_3.md)

### **Phase 3D: フロントエンド対応**
- 段階的選択UIの改善
- カテゴリ表示
- 使い残し食材の表示

**詳細**: [plan_Phase_3D.md](./plan_Phase_3D.md)

### **Phase 3E: 統合テスト**
- エンドツーエンドテスト
- 段階的選択の動作確認
- エラーハンドリング

**詳細**: [plan_Phase_3E.md](./plan_Phase_3E.md)

---

## 実装順序

1. **Phase 3A** → バックエンド汎用メソッドの実装
2. **Phase 3B** → プランナーの拡張
3. **Phase 3C-1** → セッション管理の拡張
4. **Phase 3C-2** → 段階判定機能
5. **Phase 3C-3** → 自動遷移機能
6. **Phase 3D** → フロントエンド対応
7. **Phase 3E** → 統合テスト

---

## 期待される効果

- ユーザーが主菜→副菜→汁物を段階的に選択できる
- 使い残し食材を有効活用できる
- 献立のバランスが良くなる
- 選択の楽しみが増える

---

## 制約事項

- Phase 3Aが完了してからPhase 3Bを開始
- Phase 3Bが完了してからPhase 3C-1を開始
- Phase 3C-1が完了してからPhase 3C-2を開始
- Phase 3C-2が完了してからPhase 3C-3を開始
- Phase 3C-3が完了してからPhase 3Dを開始
- Phase 3Dが完了してからPhase 3Eを開始
- 既存のPhase 1-2の機能を破壊しない
- 既存の`generate_main_dish_proposals()`は残す（後方互換性）
- フロントエンドは既存の選択UIを拡張
