# Morizo AI v2 - 実装計画

## 📋 概要

**作成日**: 2025年1月29日  
**バージョン**: 1.0  
**目的**: 段階的な実装計画とマイルストーン

> **📖 このドキュメントは全体像を示すため、最初に参照してください。**  
> **詳細な要件定義については `01_REQUIREMENTS_AND_USER_EXPERIENCE.md` を参照してください。**

## **重要** **コーデイング支援AIの行動指針**

### **コーデイング支援AIの問題の本質**

### **1. コンテキストウインドウの問題**
- 設計文書を全て読み直す → コンテキストウインドウがパンク
- パンクすると → 重要な情報を忘れる
- 忘れると → 設計思想を無視した提案をする

### **2. 破壊的な行動パターン**
- 「修正」と称して既存の実装を破壊
- 設計思想を無視した「改善」提案
- 段階的実装の意図を理解せずに変更

### **3. 行動指針**
修正作業前：
1. 現在のファイルの内容のみを確認
2. 設計文書は参照のみ（読み直さない）
3. 既存の実装は変更しない
4. 承認なしに実装しない
そして、**破壊的行動を絶対に行わない**

## 📚 ドキュメント構成

### **読み方の順序**

#### **📖 初回：全体把握（必須）**
1. **`00_IMPLEMENTATION_PLAN.md`** ← **このドキュメント（全体像）**
2. **`01_REQUIREMENTS_AND_USER_EXPERIENCE.md`** - 要件定義とユーザー体験
3. **`02_PRINCIPLES_AND_GOALS.md`** - 技術的原理原則と最終目標

### **実装時：段階的参照**
- **Phase 1実装時**: `03_LOGGING_STRATEGY.md` を参照
- **Phase 2実装時**: `06_MCP_LAYER.md` を参照
- **Phase 3実装時**: `05_SERVICE_LAYER.md` を参照
- **Phase 4実装時**: `04_CORE_ARCHITECTURE.md`, `08_PROMPT_DESIGN.md` を参照
- **Phase 5実装時**: `07_API_LAYER.md` を参照

> **重要**: 03以降のドキュメントは、該当するPhase実装時にのみ参照してください。  
> 一度に全てを読むとコンテキストウインドウの枯渇を招きます。

### **実装順序**
1. **Phase 1**: ロギング戦略（03_LOGGING_STRATEGY.md）
2. **Phase 2**: MCP層（06_MCP_LAYER.md）
3. **Phase 3**: サービス層（05_SERVICE_LAYER.md）
4. **Phase 4**: コア機能（04_CORE_ARCHITECTURE.md）
5. **Phase 5**: API層（07_API_LAYER.md）

## 🎯 実装戦略

### **段階的構築アプローチ**
1. **ロギング戦略**: 開発の基本となるロギング設定
2. **MCP層**: サービス層に利用される、疎結合なツール群を提供
3. **サービス層**: コア層に呼び出されるビジネスロジックを実装
4. **コア機能**: サービス層を呼び出してタスクを調整する、統一ReActエージェント
5. **API層**: HTTPリクエストを受け付け、コア層に処理を委譲

### **ファイルサイズ制限**
- **コア機能**: 各ファイル150行以下
- **サービス層**: 各ファイル100行以下
- **MCP層**: 各ファイル100行以下
- **API層**: 各ファイル100行以下

## 🚀 Phase 1: ロギング戦略実装

### **目標**
- 基本的なロギング設定
- 階層別ログ出力
- ログローテーション機能

### **実装ファイル**
```
config/
├── __init__.py
├── logging.py        # ロギング設定 (100行以下)
└── loggers.py        # 階層別ロガー (100行以下)
```

### **実装順序**
1. **基本ロギング設定**: ファイル・コンソール出力 ✅
2. **階層別ロガー**: API層・サービス層・MCP層 ✅
3. **ログローテーション**: 自動的なログファイル管理 ✅

### **成功基準**
- [x] 各ファイルが100行以下
- [x] 基本的なログ出力が動作
- [x] 階層別ログが動作
- [x] ログローテーションが動作

### **テスト項目**
- [x] 基本ロギング設定の動作確認
- [x] 階層別ロガーの動作確認
- [x] ログファイルの作成とローテーション
- [x] コンソール・ファイル両方への出力

### **実装完了日**
**2025年1月29日** - Phase 1完了

## 🔧 Phase 2: MCP層実装

### **目標**
- MCPサーバーの基本実装
- 疎結合な通信の実装
- ツール間連携の基本機能

### **実装内容**
- [x] RecipeMCPサーバーの実装
- [x] InventoryMCPサーバーの実装
- [x] RecipeHistoryMCPサーバーの実装
- [x] MCPクライアントの実装
- [x] 認証機能の統合
- [x] エラーハンドリング
- [x] 疎通確認テスト

### **実装完了日**
**2025年10月5日** - Phase 2完了
- [ ] 基本的なタスク実行
- [ ] エラーハンドリング

## 🔧 Phase 3: サービス層実装

### **目標**
- ビジネスロジックの実装
- データ変換・バリデーション
- エラーハンドリング

### **実装ファイル**
```
services/
├── __init__.py
├── recipe_service.py      # RecipeService (100行以下)
├── inventory_service.py   # InventoryService (100行以下)
└── session_service.py     # SessionService (100行以下)
```

### **実装順序**
1. **SessionService**: 基本的なセッション管理
2. **InventoryService**: 基本的な在庫管理
3. **RecipeService**: 基本的なレシピ管理

### **成功基準**
- [ ] 各ファイルが100行以下
- [ ] セッション管理が動作
- [ ] 在庫管理が動作
- [ ] レシピ管理が動作

### **テスト項目**
- [ ] セッションの作成・取得
- [ ] 在庫の追加・取得
- [ ] レシピの生成・検索
- [ ] サービス間連携

## 🔌 Phase 4: MCP層実装

### 目標
- 疎結合なツール通信
- 動的ツール選択
- 単独動作保証

### 実装ファイル
```
mcp_servers/
├── __init__.py
├── client.py              # MCPClient (100行以下)
├── recipe_mcp_servers.py          # RecipeMCP (100行以下)
├── inventory_mcp_servers.py       # InventoryMCP (100行以下)
└── recipe_history_mcp_servers.py  # RecipeHistoryMCP (100行以下)
```

### 実装順序
1. **InventoryMCP**: 基本的な在庫管理操作
2. **RecipeHistoryMCP**: 基本的なレシピ履歴操作
3. **RecipeMCP**: 基本的なレシピ機能
4. **MCPClient**: ツール通信の統合

### **成功基準**
- [ ] 各ファイルが100行以下
- [ ] データベース操作が動作
- [ ] レシピ機能が動作
- [ ] 疎結合通信が動作

### **テスト項目**
- [ ] 在庫CRUD操作
- [ ] レシピ生成・検索
- [ ] ツール間通信

## 🌐 Phase 5: API層実装

### **目標**
- HTTP通信の処理
- 認証・認可
- エラーハンドリング

### **実装ファイル**
```
api/
├── __init__.py
├── main.py            # FastAPIアプリ (100行以下)
├── routes/            # ルート定義
│   ├── __init__.py
│   ├── chat.py        # チャットエンドポイント (100行以下)
│   └── health.py      # ヘルスチェック (100行以下)
├── middleware/        # ミドルウェア
│   ├── __init__.py
│   ├── auth.py        # 認証ミドルウェア (100行以下)
│   └── logging.py     # ログミドルウェア (100行以下)
└── models/            # データモデル
    ├── __init__.py
    ├── requests.py    # リクエストモデル (100行以下)
    └── responses.py   # レスポンスモデル (100行以下)
```

### **実装順序**
1. **データモデル**: リクエスト・レスポンスの型定義
2. **ミドルウェア**: 認証・ログの共通処理
3. **ルート定義**: エンドポイントの実装
4. **FastAPIアプリ**: アプリケーションの統合

### **成功基準**
- [ ] 各ファイルが100行以下
- [ ] FastAPIアプリが起動
- [ ] エンドポイントが動作
- [ ] 認証・認可が動作
- [ ] エラーハンドリングが動作

### **テスト項目**
- [ ] ヘルスチェック
- [ ] チャットエンドポイント
- [ ] 認証機能
- [ ] エラーハンドリング

## 📊 統合テスト計画

### **Phase 1完了後**
- [x] ロギング戦略の動作確認
- [x] 階層別ログ出力の確認
- [x] ログローテーションの確認

### **Phase 2完了後**
- [x] MCP層の統合テスト
- [x] 疎結合通信の動作確認
- [x] ツール間連携の確認

### **Phase 3完了後**
- [ ] サービス層の統合テスト
- [ ] ビジネスロジックの動作確認
- [ ] データ変換の確認

### **Phase 4完了後**
- [ ] MCP層の統合テスト
- [ ] 疎結合通信の動作確認
- [ ] ツール間連携の確認

### **Phase 5完了後**
- [ ] 全体の統合テスト
- [ ] エンドツーエンドの動作確認
- [ ] パフォーマンステスト

## 🔍 品質保証

### **コード品質**
- [ ] ファイルサイズ制限の遵守
- [ ] 責任分離の徹底
- [ ] 疎結合設計の実現
- [ ] エラーハンドリングの実装

### **テスト品質**
- [ ] 基本動作確認の実施
- [ ] エラーハンドリングの確認
- [ ] パフォーマンスの確認
- [ ] セキュリティの確認

### **ドキュメント品質**
- [ ] 設計ドキュメントの更新
- [ ] APIドキュメントの生成
- [ ] 実装ガイドの作成
- [ ] トラブルシューティングガイドの作成

## 🚨 リスク管理

### **技術的リスク**
- **ファイルサイズ超過**: 早期のリファクタリング
- **循環依存**: 設計レビューでの早期発見
- **パフォーマンス問題**: 段階的な最適化

### **スケジュールリスク**
- **実装遅延**: 各Phaseでの完了基準の明確化
- **テスト不足**: 各Phase完了時のテスト実施
- **統合問題**: 段階的な統合テスト

### **品質リスク**
- **設計逸脱**: 定期的な設計レビュー
- **テスト不足**: 自動テストの導入
- **ドキュメント不足**: 実装と並行したドキュメント更新

## 📈 成功指標

### **機能指標**
- [ ] 統一されたReActエージェントの動作
- [ ] 在庫管理機能の動作
- [ ] レシピ提案機能の動作
- [ ] セッション管理機能の動作
- [ ] MCP統合機能の動作

### **技術指標**
- [x] Phase 1ファイルがサイズ制限内
- [ ] 全ファイルがサイズ制限内
- [ ] 循環依存の排除
- [ ] 責任分離の徹底
- [ ] 疎結合設計の実現
- [ ] テストの最小限実装

### **品質指標**
- [ ] 各モジュールの独立動作
- [ ] デバッグの容易性
- [ ] 拡張性の確保
- [ ] 保守性の確保

## 🎯 最終目標

### **機能目標**
- 現状と同様な機能の実現
- 食材重複回避機能
- レシピ保存・履歴参照機能
- セッション管理機能
- MCP統合機能

### **技術目標**
- コンテキストウインドウ最適化
- 疎結合設計の徹底
- 責任分離の実現
- ファイルサイズ制限の遵守
- テスト最小限の実装

### **品質目標**
- 保守性の向上
- 拡張性の確保
- 再利用性の確保
- デバッグ容易性の向上

---

**このドキュメントは、Morizo AI v2の実装計画を定義します。**
**すべての実装は、この計画に基づいて段階的に進められます。**
