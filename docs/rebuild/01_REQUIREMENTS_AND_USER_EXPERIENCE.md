# Morizo AI v2 - 要件定義とユーザー体験

## 📋 概要

**作成日**: 2025年1月29日  
**バージョン**: 1.0  
**目的**: プロジェクトの要件定義と期待されるユーザー体験の明確化

## 🎯 プロジェクトの目的

### **Smart Pantry MVPのAIエージェント**
- **目的**: 限られた食材から飽きの来ない献立を提案するAIエージェント
- **対象ユーザー**: 食材を効率的に活用したい個人・家庭
- **価値提案**: 食材の無駄を減らし、多様な献立を提案

### **解決する問題**
1. **食材の無駄**: 在庫食材の把握不足による廃棄
2. **献立のマンネリ**: 同じレシピの繰り返し
3. **食材の重複使用**: 同じ食材を使った主菜・副菜の提案
4. **履歴の未活用**: 過去の調理履歴を考慮しない提案

## 👥 ユーザー要件

### **主要ユーザー**
- **個人・家庭**: 日々の食事を管理したい一般ユーザー
- **ミニマリスト**: 限られた食材で多様な食事を楽しみたいユーザー
- **忙しい人**: 効率的に献立を決めたいユーザー

### **ユーザーの課題**
1. **在庫管理**: 冷蔵庫の中身を把握できない
2. **献立決定**: 何を作るか決められない
3. **食材活用**: 限られた食材で多様な料理を作りたい
4. **履歴管理**: 過去に作ったレシピを覚えていない

## 🎯 機能要件

### **1. 在庫管理機能**
- **在庫追加**: 食材の追加（名前、数量、単位、保管場所、消費期限）
- **在庫一覧**: 現在の在庫状況の確認
- **在庫更新**: 数量の変更、消費期限の更新
- **在庫削除**: 使い切った食材の削除
- **FIFO原則**: 最古の食材から使用する管理

### **2. 献立提案機能**
- **在庫ベース提案**: 現在の在庫から献立を生成
- **食材重複回避**: 同じ食材を使った主菜・副菜・汁物の提案を避ける
- **過去履歴考慮**: 過去2週間以内のレシピを除外
- **献立タイプ対応**: 和食・洋食・中華の選択
- **3品構成**: 主菜・副菜・汁物の組み合わせ

### **3. レシピ検索機能**

#### **設計思想の核心**
- **根本的な問題**: LLMには魂のこもったレシピ作成ができない
- **解決策**: 人間が蓄積してきたレシピを参照する必要がある
- **MorizoAIの役割**: LLMの独創性と人間の叡智の橋渡し

#### **2段階アプローチ**
1. **タイトル提案段階**
   - **LLM推論**: 独創的なレシピタイトルの生成（飽きの防止）
   - **RAG検索**: 蓄積レシピからタイトルを抽出（独創性の抑制）
   - **重要な制約**: ここはあくまでタイトルのみ（具体的なレシピ内容は生成しない）

2. **具体レシピ取得段階**
   - **Web検索**: 提案されたタイトルの具体的なレシピをWeb検索
   - **目的**: 人間が作った魂のこもったレシピのURLを取得
   - **結果**: 実際の調理手順を含む完全なレシピ情報

#### **並列提示システム**
- **斬新な提案**: LLM推論による独創的なタイトル
- **伝統的な提案**: RAG検索による定番タイトル
- **最終検索**: 選択されたタイトルでWeb検索実行

### **4. 履歴管理機能**
- **レシピ保存**: 作ったレシピの自動保存
- **履歴参照**: 過去の調理履歴の確認
- **重複回避**: 2週間以内のレシピ除外
- **評価機能**: レシピの評価・メモ

### **5. セッション管理機能**
- **ユーザー認証**: Supabase Authによる認証
- **セッション管理**: メモリ内セッション管理
- **権限管理**: ユーザー別データの分離

## 🎨 ユーザー体験要件

### **1. 基本的な使用フロー**

#### **シナリオ1: 在庫追加**
```
ユーザー: "牛乳1本買ってきたから、冷蔵庫に入れておいて"
Morizo: "牛乳1本を冷蔵庫に追加しました"
```

#### **シナリオ2: 献立提案**
```
ユーザー: "今の在庫で今日の献立を提案して"
Morizo: "今日の献立をご提案します！

【主菜】牛乳と卵のフレンチトースト
【副菜】ほうれん草の胡麻和え  
【汁物】白菜とハムのクリームスープ

使用食材: 牛乳、卵、パン、バター、ほうれん草、胡麻、白菜、ハム、小麦粉
残り食材: なし

※過去14日間で調理したレシピは除外しています"
```

#### **シナリオ3: レシピ検索**
```
ユーザー: "フレンチトーストの作り方を教えて"
Morizo: "フレンチトーストのレシピをご提案します！

【レシピ】牛乳と卵のフレンチトースト
【材料】牛乳200ml、卵2個、食パン4枚、バター適量
【作り方】
1. 牛乳と卵を混ぜる
2. パンを浸す
3. フライパンで焼く

詳細なレシピ: https://cookpad.com/recipe/123456"
```

### **2. エラーハンドリング**

#### **認証エラー**
```
ユーザー: (認証なしでリクエスト)
Morizo: "認証が必要です。ログインしてください。"
```

#### **在庫不足**
```
ユーザー: "在庫で献立を提案して"
Morizo: "在庫が不足しています。以下の食材を追加してください：
- 主菜用: 肉類または魚類
- 副菜用: 野菜類
- 汁物用: だし類"
```

#### **レシピ検索失敗**
```
ユーザー: "存在しないレシピを検索"
Morizo: "申し訳ございません。該当するレシピが見つかりませんでした。
類似のレシピをご提案します："
```

### **3. レスポンス時間要件**
- **シンプルメッセージ**: < 1秒
- **在庫操作**: < 2秒
- **献立提案**: < 5秒
- **レシピ検索**: < 3秒

### **4. ストリーミング対応要件**

#### **問題**
- 1分間の待機時間でユーザー体験が最悪
- 処理状況がユーザーに伝わらない
- 重たい処理の進行状況が不明
- レシピ検索の直列処理による長時間待機

#### **対応策**
- **Server-Sent Events (SSE)**: リアルタイム進捗表示
- **タスク実行状況の可視化**: 処理段階の明確化
- **進捗バーとエラー通知機能**: ユーザー体験の向上
- **並列処理**: 複数タスクの同時実行

#### **技術仕様**
- **エンドポイント**: `GET /chat/stream/{sse_session_id}`
- **認証**: Bearer Token認証
- **タイムアウト**: 120秒（Web検索処理時間を考慮）
- **進捗管理**: 0% → 25% → 50% → 75% → 100%の段階的更新
- **並列処理**: asyncio.gatherによる並列実行

#### **完了基準**
- [ ] SSEエンドポイントの実装
- [ ] 進捗表示機能の実装
- [ ] エラー通知機能の実装
- [ ] フロントエンド側の実装
- [ ] レシピ検索の並列化実装

### **5. ユーザビリティ要件**
- **直感的操作**: 自然言語での操作
- **明確な応答**: 分かりやすい説明
- **エラー対応**: 適切なエラーメッセージ
- **進捗表示**: 処理状況の可視化

### **6. 確認プロセスシステム要件**

#### **問題**
- **曖昧な操作の判断**: 「牛乳を削除して」→ どの牛乳？
- **操作の意図理解**: 「追加」vs「設定」の区別
- **複数レコードの扱い**: 同一アイテムの複数レコードの処理
- **操作履歴の活用**: 前回の操作を考慮した判断

#### **対応策**
- **曖昧性検出**: 複数アイテム操作時の自動検出
- **音声認識対応**: フロントエンドでの音声入力処理
- **タスクチェーン保持**: 確認プロセス中も全体の文脈を維持

#### **技術仕様**
- **曖昧性検出システム**: 複数アイテム存在時の自動検出
- **確認プロセス処理**: ユーザー選択の解析と処理
- **音声認識最適化**: フロントエンドでの音声入力最適化
- **文脈保持**: 確認プロセス中もタスクチェーンを維持

#### **完了基準**
- [ ] 曖昧性検出システムの実装
- [ ] 確認プロセス処理の実装
- [ ] フロントエンド音声認識最適化の実装
- [ ] タスクチェーン保持機能の実装

## 🔧 非機能要件

### **1. パフォーマンス要件**
- **同時接続数**: 100ユーザー
- **レスポンス時間**: 平均3秒以内
- **可用性**: 99.9%
- **スループット**: 100リクエスト/分

### **2. セキュリティ要件**
- **認証**: Supabase Authによる認証
- **認可**: ユーザー別データアクセス制御
- **データ保護**: 個人情報の適切な管理
- **通信暗号化**: HTTPS通信

### **3. 拡張性要件**
- **水平スケーリング**: ユーザー数増加への対応
- **機能拡張**: 新機能の追加容易性
- **データ拡張**: 大量データへの対応

### **4. 保守性要件**
- **モジュール化**: 疎結合な設計
- **テスト容易性**: 単体テスト・統合テスト
- **デバッグ容易性**: ログ出力・エラー追跡
- **ドキュメント**: 設計書・API仕様書

## 📊 成功基準

### **機能面**
- [ ] 在庫管理機能の正常動作
- [ ] 献立提案機能の正常動作
- [ ] レシピ検索機能の正常動作
- [ ] 履歴管理機能の正常動作
- [ ] セッション管理機能の正常動作

### **ユーザー体験面**
- [ ] 直感的な操作が可能
- [ ] 明確な応答が得られる
- [ ] 適切なエラーハンドリング
- [ ] 期待されるレスポンス時間

### **技術面**
- [ ] パフォーマンス要件の達成
- [ ] セキュリティ要件の達成
- [ ] 拡張性要件の達成
- [ ] 保守性要件の達成

## 🎯 期待される効果

### **ユーザーへの価値**
- **食材効率の向上**: 無駄の削減
- **献立の多様性**: 飽きの来ない提案
- **時間効率**: 献立決定時間の短縮
- **満足度向上**: 美味しい食事の提供

### **ビジネス価値**
- **ユーザー獲得**: 新規ユーザーの獲得
- **ユーザー継続**: 継続利用の促進
- **データ蓄積**: ユーザー行動データの収集
- **機能拡張**: 新機能の開発基盤

## 🔮 将来の拡張性

### **短期拡張（3-6ヶ月）**
- **音声認識**: フロントエンドでの音声入力対応
- **画像認識**: 食材画像からの在庫管理
- **レシピ評価**: ユーザー評価システム
- **買い物リスト**: 不足食材の自動生成

### **中期拡張（6-12ヶ月）**
- **栄養管理**: 栄養バランスの考慮
- **アレルギー対応**: アレルギー情報の管理
- **家族対応**: 複数ユーザーの管理
- **外部連携**: スーパー・宅配サービス連携

### **長期拡張（12ヶ月以上）**
- **AI学習**: ユーザー嗜好の学習
- **予測機能**: 在庫予測・献立予測
- **コミュニティ**: ユーザー間の情報共有
- **商用化**: 有料機能・広告収入

---

**このドキュメントは、Morizo AI v2の要件定義とユーザー体験を定義します。**
**すべての実装は、この要件に基づいて行われます。**
