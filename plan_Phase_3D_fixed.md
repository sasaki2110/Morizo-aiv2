# Phase 3D: フロントエンド対応 - 不具合対応

## 概要

Phase 3D実装完了後に発見された不具合の対応計画です。

## 発見された不具合

### 不具合1: 使い残し食材の表示が間違っている

**問題の詳細**:
- 使い残し食材が、冷蔵庫の実際の食材ではなく、ベクトルDBから取得したレシピの材料に置き換わっている
- 例: `鶏もも肉, 栗粉, ピーマン, なす, じゃがいも中`
- 期待される動作: 主菜・副菜で使用した冷蔵庫の食材を正しく表示する

**影響範囲**:
- フロントエンドの`usedIngredients`表示
- バックエンドのセッション管理（`used_ingredients`の保存）

**想定される原因**:
- セッションに保存される`used_ingredients`が、レシピの材料情報（ベクトルDB由来）をそのまま保存している
- 冷蔵庫の在庫情報とレシピ材料のマッピングが正しく行われていない
- `set_selected_recipe`メソッドで保存される食材が、レシピの`ingredients`フィールドから取得されているが、これがベクトルDBの材料名になっている

**確認が必要な箇所**:
- `services/session_service.py`の`set_selected_recipe`メソッド
- レシピ選択時に保存される`ingredients`の内容
- 冷蔵庫在庫とレシピ材料の対応関係

---

### 不具合2: 副菜で5件提案されない（LLM2件のみ、RAG3件が欠落）

**問題の詳細**:
- 副菜選択時に、5件提案のはずがLLM2件のみ提案される
- RAG3件が提案されない
- 不具合1（使い残し食材）の影響の可能性あり

**影響範囲**:
- 副菜提案機能
- RAG検索機能

**想定される原因**:
1. 使い残し食材（`used_ingredients`）が間違っているため、RAG検索で適切なレシピが見つからない
2. RAG検索のパラメータ設定に問題がある
3. `used_ingredients`の形式がRAG検索の期待する形式と異なる

**確認が必要な箇所**:
- `mcp_servers/recipe_mcp.py`の`generate_proposals`メソッド（副菜の場合）
- RAG検索時の`used_ingredients`パラメータの扱い
- 主菜で使用した食材の正しい取得方法
- RAG検索のログ確認

---

### 不具合3: 副菜選択後、汁物選択に移らない（曖昧判定される）

**問題の詳細**:
- 副菜を選択すると、汁物選択に自動遷移するはずが、曖昧性確認画面に遷移する
- メッセージ: 「なにか主な食材を指定しますか？それとも今の在庫から作れる主菜を提案しましょうか？」
- 主菜提案の曖昧性確認メッセージが表示されている

**影響範囲**:
- 段階的選択の自動遷移機能（Phase 3C-3）
- プランナーによるリクエスト解析

**想定される原因**:
1. 副菜選択後の自動遷移時に、生成される汁物提案リクエストが正しくない
2. プランナーが汁物提案リクエストを主菜提案リクエストとして誤認識している
3. `_generate_soup_request`メソッドが生成するリクエスト文字列が適切でない
4. セッションに保存された`next_stage_request`が正しくない

**確認が必要な箇所**:
- `core/agent.py`の`_generate_soup_request`メソッド
- プランナーのリクエスト解析ロジック
- 汁物提案時のリクエスト生成内容
- セッションに保存される`next_stage_request`の内容

---

## 対応方針

### 優先順位

1. **不具合1（使い残し食材）**: 最優先
   - 他の不具合にも影響している可能性が高い
   - 基本的なデータ管理の問題

2. **不具合2（副菜の5件提案）**: 不具合1対応後に確認
   - 不具合1が原因の可能性が高い

3. **不具合3（汁物自動遷移）**: 独立した問題として対応
   - リクエスト生成・解析の問題

### 調査手順

#### 不具合1の調査

1. セッションに保存される`used_ingredients`の内容確認
   - ログで`set_selected_recipe`呼び出し時の`ingredients`を確認
   - 冷蔵庫在庫と比較

2. レシピ選択時に取得されるレシピ情報の確認
   - `_get_selected_recipe_from_task`メソッドの戻り値を確認
   - レシピの`ingredients`フィールドの内容と出所を確認

3. 冷蔵庫在庫とレシピ材料の対応関係の確認
   - 在庫情報とレシピ材料のマッピングが必要か検討

#### 不具合2の調査

1. 不具合1対応後に再テスト
2. RAG検索のログ確認
   - 副菜提案時のRAG検索パラメータを確認
   - RAG検索結果が0件になっていないか確認

#### 不具合3の調査

1. 副菜選択後のリクエスト生成内容を確認
   - `_generate_soup_request`の戻り値をログ出力
   - セッションに保存される`next_stage_request`を確認

2. プランナーのリクエスト解析を確認
   - 汁物提案リクエストがどのように解析されているか
   - なぜ主菜提案と判定されているか

---

## 関連ファイル

### バックエンド

- `services/session_service.py`: セッション管理、`used_ingredients`の保存
- `core/agent.py`: 段階進行、リクエスト生成
- `mcp_servers/recipe_mcp.py`: レシピ提案、RAG検索
- `services/llm/response_processor.py`: レスポンス処理

### フロントエンド

- `components/ChatSection.tsx`: メッセージ表示、段階情報表示
- `components/SelectionOptions.tsx`: 選択UI、使い残し食材表示

---

## メモ

- 不具合1は、レシピの材料情報（ベクトルDB由来）をそのまま使っている可能性が高い
- 冷蔵庫在庫とレシピ材料の対応が必要な場合、マッピング機能の追加が必要になる可能性
- 不具合3は、リクエスト生成時の文脈が失われている可能性

