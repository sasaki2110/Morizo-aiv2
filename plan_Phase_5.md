# Phase 5: 履歴管理機能

## 概要

Phase 3で実装された段階的選択システム（主菜→副菜→汁物）において、選択したレシピを履歴として保存・閲覧する機能を実装します。

## 背景

### 現状の問題点

1. **選択履歴表示UIが未実装**
   - ユーザーが選択した主菜・副菜・汁物を視覚的に確認できない
   - 選択が確定したことを示すUIがない
   - 最終的な献立を確認するUIがない

2. **DB保存機能が未実装**
   - 選択したレシピはセッション内（メモリ）にのみ保存
   - DBに永続化されていないため、次回アクセス時に履歴が失われる
   - 重複回避機能（2週間分の履歴）が正しく機能しない

3. **過去履歴閲覧機能が未実装**
   - ユーザーが過去に選択した献立を確認できない
   - 重複警告を視覚的に確認できない
   - 2週間分の履歴を閲覧する機能がない

### worries.mdの要件

- **主菜・副菜**: 2週間程度重複を避けたい
- **汁物**: 昨日と同じでなければ、ある程度重複しても良い
- **選択の楽しみ**: 複数の選択肢から探し出す楽しみ
- **自分で決める楽しみ**: ユーザーが最終決定する

## 実装構成

Phase 5は3つのフェーズに分割して実装します。

### Phase 5A: バックエンド実装（DB保存機能）

**目的**: 選択したレシピをDBに永続化する機能を実装

**実装内容**:
- `/api/menu/save`エンドポイントの作成
- セッションから選択済みレシピの取得
- DBへの保存処理（主菜・副菜・汁物の各レシピを個別に保存）
- 各段階での保存対応（主菜のみ、主菜+副菜、全3件）

**期待される効果**:
- 選択したレシピがDBに保存され、次回アクセス時も履歴が残る
- 重複回避機能（2週間分の履歴）が正しく機能する

### Phase 5B: フロントエンド実装（選択履歴表示UI + 保存機能）

**目的**: ユーザーに選択状況を視覚的に表示し、保存できるUIを実装

**実装内容**:
- 選択確定時のカード表示（主菜・副菜・汁物それぞれ）
- 段階的な積み上げ表示（主菜 → 主菜+副菜 → 全3件）
- 「献立を保存」ボタンの実装（各段階で表示可能）
- 保存成功/失敗のフィードバック

**期待される効果**:
- ユーザーが選択状況を確認できる
- ユーザーが任意のタイミングで保存できる
- 献立完成時の確認UIが提供される

### Phase 5C: 過去履歴閲覧機能

**目的**: 過去に保存した献立履歴を閲覧する機能を実装

**実装内容**:
- 履歴パネルUI（ドロワー型またはサイドバー型）
- 日付別リスト表示（最新順、2週間分をデフォルト）
- 重複警告バッジ表示（主菜・副菜は14日前使用表示、汁物は昨日使用表示）
- フィルター機能（期間選択、カテゴリフィルター）
- 履歴からの再提案機能

**期待される効果**:
- ユーザーが過去の献立を確認できる
- 重複を視覚的に確認できる
- 過去の献立を参考にできる

## 実装順序

1. **Phase 5A** → バックエンド実装（DB保存機能）
2. **Phase 5B** → フロントエンド実装（選択履歴表示UI + 保存機能）
3. **Phase 5C** → 過去履歴閲覧機能

## 技術的な考慮事項

### DB保存形式

既存の`recipe_historys`テーブルを使用：
- 各レシピを1レコードとして保存
- `title`フィールドに「主菜: タイトル」「副菜: タイトル」「汁物: タイトル」として保存
- 既存の重複回避機能（`get_recent_recipe_titles()`）と互換性を保つ

### 保存タイミング

- **各段階での保存**: 主菜選択後、副菜選択後、汁物選択後、それぞれで「献立を保存」ボタンを表示
- **保存内容**: 選択済みのレシピのみを保存（未選択は保存しない）
- **ユーザー主導**: 自動保存ではなく、ユーザーが明示的に保存を要求した時のみ保存

### Phase 4（ロールバック機能）について

- Phase 4は挫折して後回しになったため、変更機能は含まない
- 変更したい場合は、チャットをクリアして最初から始める方式

## 詳細プラン

各フェーズの詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_5A.md](./plan_Phase_5A.md) - バックエンド実装（DB保存機能）
- [plan_Phase_5B.md](./plan_Phase_5B.md) - フロントエンド実装（選択履歴表示UI + 保存機能）
- [plan_Phase_5C.md](./plan_Phase_5C.md) - 過去履歴閲覧機能

## 期待される効果

- **ユーザー体験の向上**: 選択状況が視覚的に確認でき、献立を保存できる
- **重複回避機能の正常化**: 2週間分の履歴が正しく機能する
- **過去履歴の活用**: 過去の献立を参考にできる
- **モバイル対応**: Webアプリの実装をモバイルアプリに移植可能（別リポジトリ）

## 制約事項

- Phase 5Aが完成してからPhase 5Bを開始
- Phase 5Bが完成してからPhase 5Cを開始
- 既存のPhase 1-3の機能を破壊しない
- Phase 4（ロールバック機能）は含まない

