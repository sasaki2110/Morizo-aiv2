# Phase 5: 履歴管理機能

## 概要

Phase 3で実装された段階的選択システム（主菜→副菜→汁物）において、選択したレシピを履歴として保存・閲覧する機能を実装します。

## 背景

### 現状の問題点

1. **選択履歴表示UIが未実装**
   - ユーザーが選択した主菜・副菜・汁物を視覚的に確認できない
   - 選択が確定したことを示すUIがない
   - 最終的な献立を確認するUIがない

2. **DB保存機能が未実装**
   - 選択したレシピはセッション内（メモリ）にのみ保存
   - DBに永続化されていないため、次回アクセス時に履歴が失われる
   - 重複回避機能（2週間分の履歴）が正しく機能しない

3. **過去履歴閲覧機能が未実装**
   - ユーザーが過去に選択した献立を確認できない
   - 2週間分の履歴を閲覧する機能がない

### worries.mdの要件

- **主菜・副菜**: 2週間程度重複を避けたい
- **汁物**: 昨日と同じでなければ、ある程度重複しても良い
- **選択の楽しみ**: 複数の選択肢から探し出す楽しみ
- **自分で決める楽しみ**: ユーザーが最終決定する

## 実装構成

Phase 5は段階的に実装を進めるため、細かく分割して実装します。

### Phase 5A: バックエンド実装（DB保存機能）

**目的**: 選択したレシピをDBに永続化する機能を実装

**実装内容**:
- `/api/menu/save`エンドポイントの作成
- セッションから選択済みレシピの取得
- DBへの保存処理（主菜・副菜・汁物の各レシピを個別に保存）
- 各段階での保存対応（主菜のみ、主菜+副菜、全3件）

**期待される効果**:
- 選択したレシピがDBに保存され、次回アクセス時も履歴が残る
- 重複回避機能（2週間分の履歴）が正しく機能する

### Phase 5B: フロントエンド実装（選択履歴表示UI + 保存機能）

Phase 5Bは3つのサブフェーズに分割します。

#### Phase 5B-1: 選択履歴表示UI（コンポーネント作成）

**目的**: 選択したレシピを表示するUIコンポーネントを作成

**実装内容**:
- `SelectedRecipeCard`コンポーネントの作成
- 段階的な表示ロジック（主菜のみ、主菜+副菜、全3件）

**期待される効果**:
- コンポーネントが独立して動作する
- 次のフェーズで統合しやすい

#### Phase 5B-2: 選択確定時の情報取得

**目的**: 選択確定時に、選択したレシピの詳細情報を取得する方法を実装

**実装内容**:
- バックエンドレスポンス拡張（案1を推奨）またはフロントエンドでの情報取得（案2）
- 選択確定時のレシピ情報取得処理

**期待される効果**:
- 選択確定時にレシピ情報が確実に取得できる
- Phase 5B-1で作成したコンポーネントにデータを渡せる

#### Phase 5B-3: 保存機能の実装と統合

**目的**: `SelectedRecipeCard`を`ChatSection`に統合し、保存機能を実装

**実装内容**:
- `ChatSection`へのコンポーネント統合
- 「献立を保存」ボタンの実装
- Phase 5AのAPI呼び出し
- 保存成功/失敗のフィードバック

**期待される効果**:
- ユーザーが任意のタイミングで保存できる
- 保存成功/失敗のフィードバックが提供される

### Phase 5C: 過去履歴閲覧機能

Phase 5Cは3つのサブフェーズに分割します。

#### Phase 5C-1: バックエンドAPI拡張（履歴取得）

**目的**: 過去に保存した献立履歴を取得するAPIを実装

**実装内容**:
- `/api/menu/history`エンドポイントの実装
- 日付別グループ化
- カテゴリフィルター対応

**期待される効果**:
- 過去の献立履歴を取得できる
- 日付別に整理されたデータが提供される

#### Phase 5C-2: 重複警告計算機能

**⚠️ このフェーズは実装不要のためスキップします。**

提案時に既に重複除外が実装されているため、履歴ビューワーでの重複警告表示は不要と判断しました。

**目的（参考）**: 履歴に対して重複警告を計算する機能を実装

**実装内容（参考）**:
- 重複警告計算ロジック（主菜・副菜は14日前、汁物は昨日）
- APIレスポンスへの統合

**期待される効果（参考）**:
- 重複警告が自動的に計算される
- フロントエンドで警告を表示できる

#### Phase 5C-3: フロントエンドUI実装（履歴パネル）

**目的**: 履歴を閲覧できるフロントエンドUIを実装

**実装内容**:
- `HistoryPanel`コンポーネントの作成
- フィルター機能
- `ChatSection`への統合

**期待される効果**:
- ユーザーが過去の献立を確認できる

## 実装順序

1. **Phase 5A** → バックエンド実装（DB保存機能）
2. **Phase 5B-1** → 選択履歴表示UI（コンポーネント作成）
3. **Phase 5B-2** → 選択確定時の情報取得
4. **Phase 5B-3** → 保存機能の実装と統合
5. **Phase 5C-1** → バックエンドAPI拡張（履歴取得）
6. **Phase 5C-2** → 重複警告計算機能（⚠️ **実装不要のためスキップ**）
7. **Phase 5C-3** → フロントエンドUI実装（履歴パネル）

## 技術的な考慮事項

### 既存エンドポイント `/api/recipe/adopt` との競合
- 現在、レシピを保存する同様のエンドポイントが存在するが、新設する `/api/menu/save` とは保存するデータの命名規則が異なる。
- この非互換性は、Phase 5Cで計画している重複チェック機能を破綻させる危険性があるため、Phase 5Aに着手する前に機能統一やリファクタリングが必要となる。
- 詳細は `plan_Phase_5A.md` の「既存エンドポイントとの関連性と課題」セクションを参照。

### DB保存形式

既存の`recipe_historys`テーブルを使用：
- 各レシピを1レコードとして保存
- `title`フィールドに「主菜: タイトル」「副菜: タイトル」「汁物: タイトル」として保存
- 既存の重複回避機能（`get_recent_recipe_titles()`）と互換性を保つ

### 保存タイミング

- **各段階での保存**: 主菜選択後、副菜選択後、汁物選択後、それぞれで「献立を保存」ボタンを表示
- **保存内容**: 選択済みのレシピのみを保存（未選択は保存しない）
- **ユーザー主導**: 自動保存ではなく、ユーザーが明示的に保存を要求した時のみ保存

### Phase 4（ロールバック機能）について

- Phase 4は挫折して後回しになったため、変更機能は含まない
- 変更したい場合は、チャットをクリアして最初から始める方式

## 詳細プラン

各フェーズの詳細な実装計画は以下のファイルを参照してください：

- [plan_Phase_5A.md](./plan_Phase_5A.md) - バックエンド実装（DB保存機能）
- [plan_Phase_5B_1.md](./plan_Phase_5B_1.md) - 選択履歴表示UI（コンポーネント作成）
- [plan_Phase_5B_2.md](./plan_Phase_5B_2.md) - 選択確定時の情報取得
- [plan_Phase_5B_3.md](./plan_Phase_5B_3.md) - 保存機能の実装と統合
- [plan_Phase_5C_1.md](./plan_Phase_5C_1.md) - バックエンドAPI拡張（履歴取得）
- [plan_Phase_5C_2.md](./plan_Phase_5C_2.md) - 重複警告計算機能（⚠️ **実装不要のためスキップ**）
- [plan_Phase_5C_3.md](./plan_Phase_5C_3.md) - フロントエンドUI実装（履歴パネル）

## 期待される効果

- **ユーザー体験の向上**: 選択状況が視覚的に確認でき、献立を保存できる
- **重複回避機能の正常化**: 2週間分の履歴が正しく機能する
- **過去履歴の活用**: 過去の献立を参考にできる
- **モバイル対応**: Webアプリの実装をモバイルアプリに移植可能（別リポジトリ）

## 制約事項

- Phase 5Aが完成してからPhase 5B-1を開始
- Phase 5B-1が完成してからPhase 5B-2を開始
- Phase 5B-2が完成してからPhase 5B-3を開始
- Phase 5B-3が完成してからPhase 5C-1を開始
- Phase 5C-1が完成してからPhase 5C-3を開始（Phase 5C-2はスキップ）
- 既存のPhase 1-3の機能を破壊しない
- Phase 4（ロールバック機能）は含まない

